<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Progressive Self-Development — Tiered</title>
<meta name="color-scheme" content="dark">
<style>
/* ================ THEME ================ */
:root{
  /* brand */
  --ink:#e9ecff;
  --muted:#9aa3b2;
  --bg:#0b0f1a;
  --bg-2:#0e1423;
  --card:#101828cc; /* glass */
  --stroke:#1e293b80;
  --ring: 0 10px 40px rgba(64,152,255,.18);

  /* accents */
  --pri:#4f7df3;  /* blue */
  --pri-2:#9aa6ff;
  --good:#10b981;
  --bad:#ef4444;
  --amber:#f59e0b;
  --diamond:#8b5cf6;

  /* progress skins */
  --bar-bg:#121a2a;
  --bar-fill:#3b82f6;
  --bar-fill-2:#eab308;
  --bar-fill-3:#a78bfa;

  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--ink);background:
  radial-gradient(1200px 600px at 65% -10%, #19306a22 0%, transparent 60%),
  radial-gradient(1100px 800px at -10% 120%, #311a6d22 0%, transparent 50%),
  linear-gradient(180deg,#0a1020 0%, #070b15 100%);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial, sans-serif;
}
.container{max-width:1100px;margin:0 auto;padding:18px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
h1{font-size:22px;margin:0}
.card{
  background:linear-gradient(180deg,#0f1627cc,#0b1120cc);
  border:1px solid var(--stroke);
  border-radius:var(--radius);
  box-shadow:var(--ring);
  padding:14px;
}
.grid{display:grid;gap:12px}
.small{font-size:12px;color:var(--muted)}
.right{margin-left:auto}
.wrap{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

.btn{
  border:0;border-radius:12px;padding:10px 14px;font-size:14px;cursor:pointer;
  background:linear-gradient(180deg,#5786ff,#3b6df6); color:white;
  box-shadow:0 4px 22px rgba(60,120,255,.25), inset 0 0 0 1px #ffffff1a;
  transition:.15s transform, .15s filter;
}
.btn:hover{filter:brightness(1.05)}
.btn:active{transform:translateY(1px)}
.btn.secondary{
  background:linear-gradient(180deg,#1e293b,#0f172a); color:#cbd5e1;
  box-shadow:inset 0 0 0 1px #ffffff14;
}
.btn.ghost{background:transparent;border:1px solid var(--stroke);color:var(--ink)}
.btn.success{background:linear-gradient(180deg,#15c98b,#10b981)}
.btn.danger{background:linear-gradient(180deg,#ff5a55,#ef4444)}
.pill{
  display:inline-flex;gap:8px;align-items:center;
  padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);
  background:linear-gradient(180deg,#0e1628aa,#0b1120aa);
  color:#c8d3f0;font-size:12px
}

/* Topic row */
.topic{display:flex;gap:12px;align-items:center;padding:14px;border-radius:14px;border:1px solid var(--stroke);background:#0e1423a6}
.topic:hover{background:#111a30a6}
.topic-name{font-weight:700;letter-spacing:.2px}

/* Progress — segmented bar */
.progress{
  position:relative; height:16px; border-radius:999px;
  background:linear-gradient(180deg,#0b1322,#0a1020); border:1px solid #192640;
  overflow:hidden; box-shadow: inset 0 0 0 1px #0c1b35, inset 0 10px 20px #0008;
}
.progress .fill{position:absolute;inset:0 100% 0 0;
  background:linear-gradient(90deg,#60a5fa,#3b82f6 40%,#2563eb 100%);
  box-shadow:0 0 30px rgba(96,165,250,.35), inset 0 -10px 20px rgba(0,0,0,.25);
}
.progress.gold .fill{
  background:linear-gradient(90deg,#ffda7a,#f7b500 40%,#d97706 100%);
  box-shadow:0 0 30px #fbbf2433, inset 0 -10px 18px #00000030;
}
.progress.diamond .fill{
  background:linear-gradient(90deg,#b2aaff,#9b87f5 40%,#7c3aed 100%);
  box-shadow:0 0 30px #a78bfa33, inset 0 -10px 18px #00000030;
}
.progress .seg{
  position:absolute;inset:-2px auto -2px; width:1px; background:#1e293b80
}
.segment-label{font-size:11px;color:#99a2b6}

/* Circular headline % */
.ring-wrap{position:relative;width:110px;height:110px}
.ring{position:absolute;inset:0;border-radius:50%;
  background:
    conic-gradient(#3b82f6 var(--p,0%), #1e293b var(--p,0%));
  mask:
    radial-gradient(transparent 38%,#000 39%),
    linear-gradient(#000,#000);
}
.ring-inner{
  position:absolute;inset:8px;border-radius:50%;
  background:linear-gradient(180deg,#0d1324,#0b1120);display:flex;align-items:center;justify-content:center;
  color:#dbe7ff;font-weight:800;font-size:20px;letter-spacing:.5px;border:1px solid #20304b;box-shadow:inset 0 0 20px #0008
}

/* Canvas shells */
canvas{display:block;width:100%;border-radius:14px;border:1px solid var(--stroke);background:#0c1324}

/* Sub View Layout */
.sub-header{display:grid;grid-template-columns:1fr 1.1fr;gap:14px}
.tier-panel{
  display:grid;grid-template-columns:260px 1fr;gap:14px;align-items:center
}
.tier-image{
  position:relative;border-radius:14px;border:1px dashed #2b3c5c;background:#0a1224;overflow:hidden;min-height:180px;
  display:flex;align-items:center;justify-content:center;box-shadow:var(--ring)
}
.tier-image img{max-width:100%;height:auto;display:block}
.tier-caption{display:flex;gap:8px;align-items:center;justify-content:space-between}

.tier-steps{display:grid;grid-template-columns:1fr auto 1fr;gap:18px;align-items:center}
.next-image{min-height:180px;border:1px dashed #334155;border-radius:14px;background:#0a1224;display:flex;align-items:center;justify-content:center;opacity:.8}
.centered .tier-steps{grid-template-columns:1fr;}

/* Quest rows */
.quest{
  display:grid;grid-template-columns:1fr minmax(240px,300px) auto auto;gap:12px;align-items:center;
  padding:12px;border-radius:12px;border:1px solid var(--stroke);background:linear-gradient(180deg,#0d1426,#0a1120);
}
.quest .q-name{font-weight:700}
.q-cond{font-size:12px;color:#a5b0c4}
.q-bar{display:flex;flex-direction:column;gap:6px}
.q-actions{display:flex;gap:8px;}

/* Modal */
.modal{position:fixed;inset:0;display:none;place-items:center;background:#0008;z-index:60}
.dialog{width:min(820px,calc(100% - 24px));background:#0e1527;border:1px solid var(--stroke);border-radius:16px;box-shadow:0 25px 80px #000;overflow:hidden}
.dialog header, .dialog footer{padding:12px 14px;border-bottom:1px solid var(--stroke);display:flex;gap:10px;align-items:center;justify-content:space-between}
.dialog footer{border-top:1px solid var(--stroke);border-bottom:0;background:#0c1426;position:sticky;bottom:0}
.dialog .body{padding:14px}
input[type="text"], input[type="number"], textarea, input[type="file"], select{
  width:100%;padding:10px;border:1px solid #25324a;border-radius:10px;background:#0b1324;color:#dbe7ff
}
textarea{min-height:80px;resize:vertical}

/* sticky action bar */
.sticky-ops{position:sticky;bottom:12px;display:flex;gap:10px;justify-content:flex-start}

/* history */
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #23314b;font-size:13px}
th{color:#a2b0c8;text-align:left}
.note-cell{white-space:pre-wrap;word-break:break-word}

/* chips */
.chip{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid #32425f;background:#0c152a;font-size:12px}
.chip.gold{border-color:#f59e0b66;color:#f8d78a;background:#2a1e07}
.chip.purple{border-color:#8b5cf666;color:#cabdfc;background:#1d1237}

/* helpers */
.hr{height:1px;background:#23314b;margin:12px 0}
.hide{display:none !important}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="wrap">
      <h1>Progressive Self-Development</h1>
      <span class="pill">v3 • Tiered</span>
    </div>
    <div class="wrap">
      <button class="btn" id="addTopicBtn">เพิ่มหัวข้อหลัก</button>
      <button class="btn secondary" id="exportAllBtn">ส่งออกข้อมูลทั้งหมด</button>
    </div>
  </header>

  <!-- Circle headline -->
  <div class="wrap" style="gap:18px;align-items:center;margin-bottom:10px">
    <div class="ring-wrap">
      <div class="ring" id="ring" style="--p:0%"></div>
      <div class="ring-inner" id="ringText">0%</div>
    </div>
    <div class="small">แตะหัวข้อหลักเพื่อเข้าไปดูหัวข้อย่อย • ความคืบหน้ากลางคำนวณจากค่าเฉลี่ย % ของหัวข้อหลักทั้งหมด</div>
  </div>

  <!-- Radar / overview -->
  <div class="card">
    <div class="small" style="margin-bottom:6px">สรุปภาพรวมหน้าแรก</div>
    <canvas id="radarCanvas" height="150"></canvas>
  </div>

  <!-- HOME -->
  <section id="homeView" class="grid" style="margin-top:12px">
    <div id="topicsList" class="grid"></div>
  </section>

  <!-- MAIN -->
  <section id="mainView" class="grid hide">
    <div class="wrap" style="gap:8px;align-items:center">
      <button class="btn ghost" id="backHomeBtn">← กลับหน้าแรก</button>
      <div id="mainTitle" style="font-size:18px;font-weight:800"></div>
      <span class="chip right" id="mainSummary"></span>
      <button class="btn danger" id="deleteMainBtn">ลบหัวข้อหลักนี้</button>
      <button class="btn secondary" id="addSubBtn">เพิ่มหัวข้อย่อย</button>
    </div>

    <div id="subsList" class="grid"></div>
  </section>

  <!-- SUB -->
  <section id="subView" class="grid hide">
    <div class="wrap" style="gap:8px;align-items:center">
      <button class="btn ghost" id="backMainBtn">← กลับหัวข้อหลัก</button>
      <div id="subTitle" style="font-size:18px;font-weight:800"></div>
      <span class="chip right" id="subLive"></span>
      <button class="btn secondary" id="manageTiersBtn">จัดการ Tier</button>
      <button class="btn danger" id="deleteSubBtn">ลบหัวข้อย่อยนี้</button>
    </div>

    <!-- Tier overview header -->
    <div class="card" id="tierHeaderCard">
      <div class="sub-header" id="tierHeaderArea">
        <!-- left: images + caption -->
        <div class="tier-panel">
          <div class="tier-image" id="tierImgCurrent"><span class="small">ยังไม่มีรูป</span></div>
          <div>
            <div class="tier-caption">
              <div class="chip" id="subTierChip">Tier 1 / 1</div>
              <div class="small" id="tierNameNow">–</div>
            </div>
            <div style="margin-top:10px">
              <div class="small">ความคืบหน้ารวมเฉลี่ยจากทุก Quest</div>
              <div class="progress" id="subProgressBar"><div class="fill"></div></div>
              <div class="segment-label"><span id="subProgressLabel">0%</span></div>
            </div>
          </div>
        </div>

        <!-- right: current → next or centered on final -->
        <div id="tierNextPanel">
          <div class="tier-steps" id="tierStepBox">
            <div class="progress" id="tierStepsBar"><div class="fill"></div></div>
            <div class="chip" id="tierStepChip">→ Tier ถัดไป</div>
            <div class="next-image" id="tierImgNext"><span class="small">Tier ถัดไป</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quests -->
    <div class="card">
      <div class="wrap">
        <h3 style="margin:0">Quests</h3>
        <button class="btn secondary right" id="addQuestBtn">เพิ่ม Quest</button>
      </div>
      <div id="questsList" class="grid" style="margin-top:8px"></div>

      <div class="sticky-ops">
        <button class="btn success" id="applyStageBtn">Save (บันทึกการเปลี่ยนแปลง)</button>
        <button class="btn secondary" id="discardStageBtn">ยกเลิกการเปลี่ยนแปลง</button>
      </div>
    </div>

    <!-- History -->
    <div class="card">
      <div class="wrap">
        <h3 style="margin:0">ประวัติ</h3>
        <button class="btn secondary right" id="exportCsvBtn">ส่งออก CSV</button>
      </div>
      <table>
        <colgroup><col style="width:190px"><col><col style="width:120px"></colgroup>
        <thead><tr><th>วัน/เวลา</th><th>รายละเอียด</th><th>ชนิด</th></tr></thead>
        <tbody id="historyTbody"></tbody>
      </table>
    </div>
  </section>
</div>

<!-- MODALS -->
<!-- Note modal for + / - -->
<div class="modal" id="noteModal">
  <div class="dialog">
    <header>
      <div>
        <div class="small" id="nmPath">หัวข้อหลัก › ย่อย › เควส</div>
        <div style="font-weight:700" id="nmTitle"></div>
      </div>
      <button class="btn ghost" id="nmClose">ปิด</button>
    </header>
    <div class="body">
      <label class="small">บันทึกสั้นๆ (ไม่บังคับ)</label>
      <textarea id="nmInput" placeholder="เช่น ทำครบเช็กลิสต์ตอนเช้า"></textarea>
      <div class="hr"></div>
      <div class="small">ประวัติของเควสนี้ (ล่าสุด)</div>
      <div id="nmHist" class="small" style="max-height:200px;overflow:auto;border:1px solid var(--stroke);border-radius:10px;padding:10px;background:#0b1324"></div>
    </div>
    <footer>
      <span class="chip" id="nmDelta">+0</span>
      <div class="right wrap">
        <button class="btn secondary" id="nmCancel">ยกเลิก</button>
        <button class="btn success" id="nmSave">เพิ่มเข้า “ค้างบันทึก”</button>
      </div>
    </footer>
  </div>
</div>

<!-- Manage tiers modal -->
<div class="modal" id="tiersModal">
  <div class="dialog" style="max-height:90vh;display:flex;flex-direction:column">
    <header>
      <div style="font-weight:700">จัดการ Tier ของหัวข้อย่อย</div>
      <button class="btn ghost" id="tmClose">ปิด</button>
    </header>
    <div class="body" style="overflow:auto">
      <div class="wrap">
        <button class="btn success" id="tmAddTier">เพิ่ม Tier</button>
        <button class="btn danger" id="tmReset">ล้างค่าความคืบหน้า (รีเซ็ตเฉพาะเปอร์เซ็นต์รวม)</button>
      </div>
      <div id="tmList" class="grid" style="margin-top:10px"></div>
      <div class="small">* รูปถูกเก็บแบบ data URL ใน localStorage</div>
    </div>
    <footer>
      <button class="btn success" id="tmSave">บันทึก</button>
    </footer>
  </div>
</div>

<!-- Add / edit quest modal -->
<div class="modal" id="questModal">
  <div class="dialog" style="max-height:90vh;display:flex;flex-direction:column">
    <header>
      <div style="font-weight:700" id="qmTitle">เพิ่ม Quest</div>
      <button class="btn ghost" id="qmClose">ปิด</button>
    </header>
    <div class="body" style="overflow:auto">
      <div class="grid">
        <div>
          <label>ชื่อ Quest</label>
          <input id="qmName" type="text" placeholder="เช่น Non-negotiable">
        </div>
        <div class="small">Tier ของ Quest (กำหนดหลอดและเงื่อนไขต่อ Tier)</div>
        <div id="qmTierList" class="grid"></div>
        <button class="btn secondary" id="qmAddTier">+ เพิ่ม Tier ของ Quest</button>
      </div>
    </div>
    <footer>
      <button class="btn success" id="qmSave">บันทึก</button>
    </footer>
  </div>
</div>

<script>
/* ================== STORAGE / MODEL ================== */
const DB_KEYS = ['psd_v3_tiered','psd_v3_tiered_backup','psd_v2_nested']; // read in this order
function loadDB(){
  for(const k of DB_KEYS){
    const raw = localStorage.getItem(k);
    if(raw){
      try{
        const o = JSON.parse(raw);
        if(o && o.topics) return o;
      }catch(e){}
    }
  }
  return {version:3, topics:[]};
}
function saveDB(){ localStorage.setItem('psd_v3_tiered', JSON.stringify(db)); }
function uid(){return 'id'+Math.random().toString(36).slice(2,10);}

let db = loadDB();

/* ========== DATA SHAPES (Tiered) ==========
Topic: { id, name, subs: [...] }

Sub (tiered):
{
  id, name,
  tiers: [{name, bars, imgData}], // img optional
  segs: 6,                        // segments on header bar
  quests:[Quest],
  progress:{percent:0},           // derived; store last calc for faster open
  history: [{time, text, kind}]   // kind: QUEST_TIER_UP / SUB_TIER_UP / NOTE
}

Quest:
{
  id, name,
  config:{ tiers:[{bars, condition}] }, // per-tier bars & condition text
  state:{ t:0, bar:0 },                 // current tier index, current bar progress
}
=========================================== */

/* ===== Utilities ===== */
function nowISO(){ return new Date().toISOString(); }
function pct(n){ return Math.max(0,Math.min(100,n)); }
function formatPct(n){ return (Math.round(n*10)/10)+'%'; }
function el(tag, attrs={}, html=''){ const e=document.createElement(tag); for(const k in attrs){ if(k==='class') e.className=attrs[k]; else e.setAttribute(k,attrs[k]); } if(html!==undefined) e.innerHTML=html; return e; }
function download(filename,text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1e3);}

/* ===== Tier math ===== */
// questPercent: position within full ladder (0..100)
function questPercent(q){
  const totalTiers = q.config.tiers.length || 1;
  const t = Math.min(q.state.t, totalTiers-1);
  const barsThis = q.config.tiers[t]?.bars || 1;
  const base = t / totalTiers;
  const frac = (barsThis? (q.state.bar/barsThis) : 0) / totalTiers;
  return pct((base + frac)*100);
}
// average quest → subPercent; map to sub tiers
function subPercent(sub){
  if(!sub.quests?.length) return 0;
  const avg = sub.quests.reduce((s,q)=>s+questPercent(q),0)/sub.quests.length;
  return pct(avg);
}
function subTierIndexFromPercent(sub, percent){
  const N = Math.max(1, sub.tiers?.length || 1);
  let idx = Math.floor((percent/100) * N);
  if(idx>=N) idx=N-1;
  return idx;
}

/* ===== Radar ===== */
function drawRadarOn(canvasId, labels, percents, subtitle){
  const cvs=document.getElementById(canvasId); if(!cvs) return;
  const ctx=cvs.getContext('2d');
  const cssW=(cvs.offsetWidth||cvs.clientWidth||700);
  const cssH=labels.length?260:150;
  const DPR=Math.max(1,window.devicePixelRatio||1);
  cvs.width=cssW*DPR; cvs.height=cssH*DPR; cvs.style.height=cssH+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
  ctx.clearRect(0,0,cssW,cssH);

  if(!labels.length){
    ctx.fillStyle='#9aa3b2'; ctx.font='14px ui-sans-serif,system-ui'; ctx.textAlign='center';
    ctx.fillText('ยังไม่มีหัวข้อหลัก — กด “เพิ่มหัวข้อหลัก” ด้านบน', cssW/2, cssH/2);
    return;
  }

  const N=labels.length, vals=percents.map(v=>pct(v));
  const cx=cssW/2, cy=cssH/2+8, maxR=Math.min(cssW,cssH)*0.36, steps=5;

  ctx.lineWidth=1;
  for(let s=1;s<=steps;s++){
    const r=(s/steps)*maxR; ctx.beginPath();
    for(let i=0;i<N;i++){ const a=(i/N)*Math.PI*2 - Math.PI/2; const x=cx+r*Math.cos(a), y=cy+r*Math.sin(a); i?ctx.lineTo(x,y):ctx.moveTo(x,y); }
    ctx.closePath(); ctx.strokeStyle='#22304b'; ctx.stroke();
  }
  ctx.font='12px ui-sans-serif,system-ui'; ctx.fillStyle='#b8c3db'; ctx.textAlign='center'; ctx.textBaseline='middle';
  for(let i=0;i<N;i++){
    const a2=(i/N)*Math.PI*2 - Math.PI/2; const x2=cx+maxR*Math.cos(a2), y2=cy+maxR*Math.sin(a2);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x2,y2); ctx.strokeStyle='#22304b'; ctx.stroke();
    const lx=cx+(maxR+16)*Math.cos(a2), ly=cy+(maxR+16)*Math.sin(a2); ctx.fillText(labels[i], lx, ly);
  }
  const pts=vals.map((v,i)=>{ const a=(i/N)*Math.PI*2 - Math.PI/2, r=(v/100)*maxR; return {x:cx+r*Math.cos(a), y:cy+r*Math.sin(a)}; });
  ctx.beginPath(); pts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y)); ctx.closePath();
  ctx.fillStyle='rgba(79,125,243,.18)'; ctx.strokeStyle='#4f7df3'; ctx.lineWidth=2; ctx.fill(); ctx.stroke();
  ctx.fillStyle='#75a3ff'; pts.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fill();});
  if(subtitle){ ctx.fillStyle='#9aa3b2'; ctx.font='12px ui-sans-serif,system-ui'; ctx.textAlign='left'; ctx.fillText(subtitle,12,16); }
}

/* ===== GLOBAL STATE ===== */
let currentMainId=null, currentSubId=null;
// stage: pending events before save
let stage={events:[]}; // {questId, delta:+1/-1, note}

/* ===== RENDER: HOME ===== */
const topicsList=document.getElementById('topicsList');
function homeRing(){
  const topics = db.topics||[];
  const avg = topics.length? (topics.reduce((s,t)=>s+mainPercent(t),0)/topics.length) : 0;
  document.getElementById('ring').style.setProperty('--p', pct(avg)+'%');
  document.getElementById('ringText').textContent = Math.round(avg)+'%';
}
function mainPercent(t){
  if(!t.subs?.length) return 0;
  const avg = t.subs.reduce((s,sub)=>s+subPercent(sub),0)/t.subs.length;
  return pct(avg);
}
function renderHome(){
  document.getElementById('homeView').classList.remove('hide');
  document.getElementById('mainView').classList.add('hide');
  document.getElementById('subView').classList.add('hide');
  topicsList.innerHTML='';
  if(!db.topics.length){
    const c=el('div',{class:'card small'},'ยังไม่มีหัวข้อหลัก กด “เพิ่มหัวข้อหลัก” ด้านบน');
    topicsList.appendChild(c);
  }else{
    db.topics.forEach(t=>{
      const percent = mainPercent(t);
      const row = el('div',{class:'topic'});
      row.innerHTML = `
        <div class="topic-name">${t.name}</div>
        <div class="progress" style="flex:1"><div class="fill" style="inset:0 ${100-percent}% 0 0"></div></div>
        <span class="chip">${Math.round(percent)}%</span>
        <button class="btn ghost">เปิด</button>
      `;
      row.querySelector('button').onclick=()=>openMain(t.id);
      topicsList.appendChild(row);
    });
  }
  drawRadarOn('radarCanvas', db.topics.map(t=>t.name), db.topics.map(t=>mainPercent(t)),'ค่าเฉลี่ย % ของแต่ละหัวข้อหลัก');
  homeRing();
}

/* ===== MAIN ===== */
const subsList=document.getElementById('subsList');
function openMain(id){
  currentMainId=id; currentSubId=null;
  document.getElementById('homeView').classList.add('hide');
  document.getElementById('mainView').classList.remove('hide');
  document.getElementById('subView').classList.add('hide');

  const main=db.topics.find(x=>x.id===id) || {subs:[]};
  document.getElementById('mainTitle').textContent = main.name;
  document.getElementById('mainSummary').textContent = `ค่าเฉลี่ยรวม: ${Math.round(mainPercent(main))}% • ${main.subs?.length||0} ย่อย`;

  subsList.innerHTML='';
  if(!main.subs?.length){
    const e=el('div',{class:'card small'},'ยังไม่มีหัวข้อย่อย');
    subsList.appendChild(e);
  }else{
    main.subs.forEach(sub=>{
      const p=subPercent(sub);
      const row=el('div',{class:'topic'});
      row.innerHTML=`
        <div class="topic-name">${sub.name}</div>
        <div class="progress" style="flex:1"><div class="fill" style="inset:0 ${100-p}% 0 0"></div></div>
        <span class="chip">Tier ${subTierIndexFromPercent(sub,p)+1}/${Math.max(1,sub.tiers?.length||1)} • ${Math.round(p)}%</span>
        <button class="btn ghost">จัดการ</button>`;
      row.querySelector('button').onclick=()=>openSub(sub.id);
      subsList.appendChild(row);
    });
  }
}

/* ===== SUB ===== */
function openSub(subId){
  currentSubId=subId;
  document.getElementById('homeView').classList.add('hide');
  document.getElementById('mainView').classList.add('hide');
  document.getElementById('subView').classList.remove('hide');
  stage={events:[]};
  renderSub();
}
function renderSub(){
  const main=db.topics.find(t=>t.id===currentMainId);
  const sub=main.subs.find(s=>s.id===currentSubId);
  document.getElementById('subTitle').textContent = `${main.name} › ${sub.name}`;
  const p = subPercent(sub);
  document.getElementById('subLive').textContent = `ค่า ณ ปัจจุบัน: ${Math.round(p)}%`;

  // header tier visuals
  const ti = subTierIndexFromPercent(sub,p);
  const N = Math.max(1, sub.tiers?.length||1);
  const tNow=sub.tiers?.[ti]||{name:'–'};
  const tNext=sub.tiers?.[ti+1] || null;

  // current img
  const cur = document.getElementById('tierImgCurrent'); cur.innerHTML='';
  if(tNow?.imgData){ const img=new Image(); img.src=tNow.imgData; cur.appendChild(img); }
  else cur.innerHTML='<span class="small">ยังไม่มีรูป</span>';
  document.getElementById('tierNameNow').textContent = tNow?.name||'-';
  document.getElementById('subTierChip').textContent = `Tier ${ti+1} / ${N}`;
  const headerBar=document.getElementById('subProgressBar').querySelector('.fill');
  headerBar.style.inset=`0 ${100-p}% 0 0`;
  document.getElementById('subProgressLabel').textContent = Math.round(p)+'%';

  const box=document.getElementById('tierStepBox');
  const nextWrap=document.getElementById('tierNextPanel');
  if(!tNext){ // final: center image
    nextWrap.classList.add('centered');
    box.innerHTML='';
    const note=document.createElement('div'); note.className='small'; note.textContent='ถึง Tier สูงสุดแล้ว';
    nextWrap.innerHTML=''; nextWrap.appendChild(note);
  }else{
    nextWrap.classList.remove('centered');
    document.getElementById('tierStepChip').textContent = `→ ${tNext.name||('Tier '+(ti+2))}`;
    const nxt=document.getElementById('tierImgNext'); nxt.innerHTML='';
    if(tNext?.imgData){ const img2=new Image(); img2.src=tNext.imgData; nxt.appendChild(img2); }
    else nxt.innerHTML='<span class="small">Tier ถัดไป</span>';
    // steps bar shows progress relative to next tier
    const frac = ((p/100)*N - ti) * (100); // percent inside this span
    document.getElementById('tierStepsBar').querySelector('.fill').style.inset=`0 ${100-pct(frac)}% 0 0`;
  }

  // quests
  renderQuests(sub);
  renderHistory(sub);
}

/* ===== QUESTS ===== */
const questsList=document.getElementById('questsList');
function renderQuests(sub){
  questsList.innerHTML='';
  if(!sub.quests?.length){
    const e=el('div',{class:'small'},'ยังไม่มี Quest'); questsList.appendChild(e);
    return;
  }
  sub.quests.forEach(q=>{
    const p=questPercent(q);
    const tIdx = Math.min(q.state.t, q.config.tiers.length-1);
    const barsNeed = q.config.tiers[tIdx]?.bars || 1;
    const skin = tIdx>=2? 'diamond' : (tIdx===1? 'gold' : '');

    const row=el('div',{class:'quest'});
    row.innerHTML=`
      <div>
        <div class="q-name">${q.name} <span class="chip ${tIdx>=2?'purple':(tIdx===1?'gold':'')}">T${tIdx+1} / T${q.config.tiers.length}</span></div>
        <div class="q-cond">${q.config.tiers[tIdx]?.condition||''}</div>
      </div>
      <div class="q-bar">
        <div class="progress ${skin}" style="--seg:${barsNeed}">
          <div class="fill" style="inset:0 ${100-p}% 0 0"></div>
          ${Array.from({length:barsNeed-1}).map((_,i)=>`<div class="seg" style="left:${((i+1)/barsNeed)*100}%"></div>`).join('')}
        </div>
        <div class="segment-label">${q.state.bar}/${barsNeed} หน่วย</div>
      </div>
      <div class="q-actions">
        <button class="btn success">เพิ่ม +</button>
        <button class="btn danger">ลด −</button>
      </div>
      <div class="wrap">
        <button class="btn secondary">แก้ไข</button>
        <button class="btn ghost">ลบ</button>
      </div>
    `;
    const [bPlus,bMinus]=row.querySelectorAll('.q-actions .btn');
    bPlus.onclick = ()=>openNoteModal('plus', q);
    bMinus.onclick = ()=>openNoteModal('minus', q);
    const [bEdit,bDel]=row.querySelectorAll('.wrap .btn');
    bEdit.onclick = ()=>openQuestEditor(q);
    bDel.onclick  = ()=>{ if(!confirm('ลบเควสนี้?'))return; sub.quests=sub.quests.filter(x=>x.id!==q.id); saveDB(); renderSub(); };

    questsList.appendChild(row);
  });
}

/* Note modal (+ / - staging) */
let modalQuest=null, modalDelta=0, modalAction='plus';
function openNoteModal(action, quest){
  const main=db.topics.find(t=>t.id===currentMainId);
  const sub=main.subs.find(s=>s.id===currentSubId);

  modalQuest=quest; modalAction=action; modalDelta=(action==='plus'?+1:-1);
  document.getElementById('nmTitle').textContent = quest.name;
  document.getElementById('nmPath').textContent = `${main.name} › ${sub.name}`;
  document.getElementById('nmDelta').textContent = (modalDelta>0?'+':'')+modalDelta;
  document.getElementById('nmInput').value='';
  // history (last 20)
  const items=(sub.history||[]).filter(h=>h.text?.includes(quest.name)).slice(-20).reverse();
  document.getElementById('nmHist').innerHTML = items.length? items.map(h=>{
    const d=new Date(h.time).toLocaleString();
    return `<div>${d} — ${h.text}</div>`;
  }).join('') : '<div class="small">ยังไม่มีประวัติของเควสนี้</div>';

  document.getElementById('noteModal').style.display='grid';
}
function closeNoteModal(){ document.getElementById('noteModal').style.display='none'; }
document.getElementById('nmClose').onclick=closeNoteModal;
document.getElementById('nmCancel').onclick=closeNoteModal;
document.getElementById('noteModal').addEventListener('click',e=>{ if(e.target.id==='noteModal') closeNoteModal(); });
document.getElementById('nmSave').onclick=()=>{
  if(!modalQuest) return;
  stage.events.push({questId:modalQuest.id, delta:modalDelta, note:document.getElementById('nmInput').value.trim()});
  closeNoteModal();
  applyStagePreview(); // live preview without saving
};

/* Live update (not persisted) */
function applyStagePreview(){
  if(!stage.events.length) return;
  const main=db.topics.find(t=>t.id===currentMainId);
  const sub=main.subs.find(s=>s.id===currentSubId);

  // clone minimal quest states for preview
  const clone = JSON.parse(JSON.stringify(sub.quests));
  stage.events.forEach(ev=>{
    const q = clone.find(x=>x.id===ev.questId); if(!q) return;
    const need = q.config.tiers[Math.min(q.state.t,q.config.tiers.length-1)]?.bars||1;
    q.state.bar += ev.delta>0?1:-1;
    if(q.state.bar<0){ if(q.state.t>0){ q.state.t-=1; q.state.bar=(q.config.tiers[q.state.t]?.bars||1)-1; } else q.state.bar=0; }
    if(q.state.bar>=need){ q.state.bar=0; if(q.state.t<q.config.tiers.length-1) q.state.t+=1; }
  });

  // temp compute percent & reflect header only
  const tempSub = {...sub, quests:clone};
  const p = subPercent(tempSub);
  document.querySelector('#subProgressBar .fill').style.inset=`0 ${100-p}% 0 0`;
  document.getElementById('subProgressLabel').textContent=Math.round(p)+'%';
}

/* Save stage → mutate real data */
document.getElementById('applyStageBtn').onclick=()=>{
  const main=db.topics.find(t=>t.id===currentMainId);
  const sub=main.subs.find(s=>s.id===currentSubId);
  if(!stage.events.length){ alert('ไม่มีรายการค้างบันทึก'); return; }

  const beforePercent = subPercent(sub);
  stage.events.forEach(ev=>{
    const q=sub.quests.find(x=>x.id===ev.questId); if(!q) return;
    const need = q.config.tiers[Math.min(q.state.t,q.config.tiers.length-1)]?.bars||1;
    // apply
    if(ev.delta>0){
      q.state.bar += 1;
      if(q.state.bar>=need){ q.state.bar=0; if(q.state.t<q.config.tiers.length-1){ q.state.t+=1; sub.history?.push({time:nowISO(),text:`${q.name} → T${q.state.t+1}`,kind:'QUEST_TIER_UP'}); } }
    }else{
      q.state.bar -= 1;
      if(q.state.bar<0){ if(q.state.t>0){ q.state.t-=1; q.state.bar=(q.config.tiers[q.state.t]?.bars||1)-1; } else q.state.bar=0; }
    }
    if(ev.note){ sub.history?.push({time:nowISO(),text:`${q.name}: ${ev.note}`,kind:'NOTE'}); }
  });

  const afterPercent = subPercent(sub);
  // record sub tier change by percent mapping
  const beforeIdx=subTierIndexFromPercent(sub,beforePercent);
  const afterIdx =subTierIndexFromPercent(sub,afterPercent);
  if(afterIdx>beforeIdx){
    sub.history?.push({time:nowISO(),text:`เลื่อนเป็น Tier ${afterIdx+1} • ${sub.tiers[afterIdx]?.name||''}`,kind:'SUB_TIER_UP'});
  }else if(afterIdx<beforeIdx){
    sub.history?.push({time:nowISO(),text:`ลดเป็น Tier ${afterIdx+1} • ${sub.tiers[afterIdx]?.name||''}`,kind:'SUB_TIER_DOWN'});
  }

  saveDB(); stage={events:[]};
  renderSub(); openMain(currentMainId); // refresh parent summary too
  alert('บันทึกแล้ว');
};
document.getElementById('discardStageBtn').onclick=()=>{ stage={events:[]}; renderSub(); };

/* History */
function renderHistory(sub){
  const tb=document.getElementById('historyTbody'); tb.innerHTML='';
  (sub.history||[]).slice().reverse().forEach(h=>{
    const tr=el('tr'); tr.innerHTML=`<td>${new Date(h.time).toLocaleString()}</td><td class="note-cell">${h.text||''}</td><td>${h.kind||''}</td>`;
    tb.appendChild(tr);
  });
}
document.getElementById('exportCsvBtn').onclick=()=>{
  const main=db.topics.find(t=>t.id===currentMainId);
  const sub=main.subs.find(s=>s.id===currentSubId);
  const rows=[['time','text','kind']].concat((sub.history||[]).map(r=>[r.time,r.text||'',r.kind||'']));
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  download(`${main.name.replace(/\s+/g,'_')}__${sub.name.replace(/\s+/g,'_')}_history.csv`, csv);
};

/* ===== Manage tiers ===== */
const tiersModal=document.getElementById('tiersModal');
function openTiersModal(){
  const main=db.topics.find(t=>t.id===currentMainId);
  const sub=main.subs.find(s=>s.id===currentSubId);
  const list=document.getElementById('tmList'); list.innerHTML='';
  (sub.tiers||[]).forEach((t,idx)=>{
    const row=el('div',{class:'card'});
    row.innerHTML=`
      <div class="wrap"><div class="chip">Tier ${idx+1}</div><div class="right"><button class="btn ghost" data-del="${idx}">ลบ</button></div></div>
      <div class="grid" style="margin-top:8px">
        <div><label>ชื่อ Tier</label><input type="text" value="${t.name||('Tier '+(idx+1))}" data-name="${idx}"></div>
        <div><label>จำนวนหน่วยที่ต้องใช้ถึง Tier ถัดไป</label><input type="number" min="1" step="1" value="${t.bars||5}" data-bars="${idx}"></div>
        <div><label>รูปภาพ (อัปเดตได้)</label><input type="file" accept="image/*" data-file="${idx}"><div class="small">ปัจจุบัน: ${t.imgData?'✔ มีรูป':'—'}</div></div>
      </div>`;
    list.appendChild(row);
  });
  // handlers
  list.querySelectorAll('input[data-file]').forEach(inp=>{
    inp.onchange=async e=>{
      const file=e.target.files[0]; if(!file) return;
      const data=await fileToDataURL(file);
      const i=+e.target.getAttribute('data-file'); sub.tiers[i].imgData=data; saveDB();
    };
  });
  list.querySelectorAll('input[data-name]').forEach(inp=>{
    inp.oninput=e=>{ const i=+e.target.getAttribute('data-name'); sub.tiers[i].name=e.target.value; };
  });
  list.querySelectorAll('input[data-bars]').forEach(inp=>{
    inp.oninput=e=>{ const i=+e.target.getAttribute('data-bars'); sub.tiers[i].bars=Math.max(1,Number(e.target.value||1)); };
  });
  list.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick=()=>{ const i=+btn.getAttribute('data-del'); if(!confirm('ลบ Tier นี้?')) return; sub.tiers.splice(i,1); saveDB(); openTiersModal(); };
  });

  tiersModal.style.display='grid';
}
function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file);}); }
document.getElementById('manageTiersBtn').onclick=openTiersModal;
document.getElementById('tmClose').onclick=()=>tiersModal.style.display='none';
tiersModal.addEventListener('click',e=>{ if(e.target.id==='tiersModal') tiersModal.style.display='none'; });
document.getElementById('tmAddTier').onclick=()=>{
  const sub=db.topics.find(t=>t.id===currentMainId).subs.find(s=>s.id===currentSubId);
  sub.tiers=sub.tiers||[]; sub.tiers.push({name:`Tier ${sub.tiers.length+1}`,bars:5,imgData:null});
  saveDB(); openTiersModal();
};
document.getElementById('tmReset').onclick=()=>{
  if(!confirm('รีเซ็ตเปอร์เซ็นต์รวม (ไม่แตะ Quest) ?'))return;
  // nothing to store, header percentมาจาก quest อยู่แล้ว แค่รีเฟรช
  renderSub();
};
document.getElementById('tmSave').onclick=()=>{ saveDB(); tiersModal.style.display='none'; renderSub(); };

/* ===== Add / Edit Quest ===== */
const questModal=document.getElementById('questModal');
let qmEditingId=null;
function openQuestEditor(q){
  const sub=db.topics.find(t=>t.id===currentMainId).subs.find(s=>s.id===currentSubId);
  qmEditingId=q?.id||null;
  document.getElementById('qmTitle').textContent= q? 'แก้ไข Quest' : 'เพิ่ม Quest';
  document.getElementById('qmName').value = q?.name||'';
  const list=document.getElementById('qmTierList'); list.innerHTML='';
  const tiers = q?.config?.tiers?.length? JSON.parse(JSON.stringify(q.config.tiers)) : [{bars:5,condition:''}];
  tiers.forEach((t,idx)=> list.appendChild(qmTierRow(t,idx,tiers,list)));
  document.getElementById('qmAddTier').onclick=()=>{ tiers.push({bars:5,condition:''}); list.appendChild(qmTierRow({bars:5,condition:''},tiers.length-1,tiers,list)); };
  document.getElementById('qmSave').onclick=()=>{
    const name=document.getElementById('qmName').value.trim(); if(!name) return alert('กรุณาใส่ชื่อ');
    // read tiers
    const readT=Array.from(list.querySelectorAll('[data-idx]')).map(div=>{
      const i=+div.getAttribute('data-idx');
      const bars=Math.max(1,Number(div.querySelector('[data-bars]').value||1));
      const cond=div.querySelector('[data-cond]').value||'';
      return {bars:bars, condition:cond};
    }).filter(Boolean);
    if(!readT.length) return alert('ต้องมีอย่างน้อย 1 Tier');
    if(q){ q.name=name; q.config.tiers=readT; q.state.t=Math.min(q.state.t, readT.length-1); q.state.bar=Math.min(q.state.bar, (readT[q.state.t]?.bars||1)-1); }
    else{ sub.quests.push({id:uid(), name, config:{tiers:readT}, state:{t:0,bar:0}}); }
    saveDB(); questModal.style.display='none'; renderSub();
  };
  questModal.style.display='grid';
}
function qmTierRow(t,idx,tiers,list){
  const r=el('div',{class:'card', 'data-idx':idx});
  r.innerHTML=`
    <div class="wrap">
      <div class="chip">T${idx+1}</div>
      <div class="right"><button class="btn ghost" data-del>ลบ</button></div>
    </div>
    <div class="grid" style="margin-top:8px">
      <div><label>จำนวนหน่วย (bars)</label><input type="number" min="1" step="1" value="${t.bars||5}" data-bars></div>
      <div><label>เงื่อนไขที่ Tier นี้</label><input type="text" value="${t.condition||''}" data-cond placeholder="เช่น ทำครบเช้า-กลางวัน-เย็น"></div>
    </div>`;
  r.querySelector('[data-del]').onclick=()=>{ if(!confirm('ลบ Tier นี้?'))return; const i=[...list.children].indexOf(r); tiers.splice(i,1); list.removeChild(r); [...list.children].forEach((c,ix)=>c.setAttribute('data-idx',ix)); };
  return r;
}
document.getElementById('qmClose').onclick=()=>questModal.style.display='none';
questModal.addEventListener('click',e=>{ if(e.target.id==='questModal') questModal.style.display='none'; });

document.getElementById('addQuestBtn').onclick=()=>openQuestEditor(null);

/* ===== Global Buttons ===== */
document.getElementById('addTopicBtn').onclick=()=>{
  const name=prompt('ชื่อหัวข้อหลัก'); if(!name) return;
  db.topics.push({id:uid(), name:name.trim(), subs:[]}); saveDB(); renderHome();
};
document.getElementById('exportAllBtn').onclick=()=>download('progress_backup_tiered.json', JSON.stringify(db,null,2));
document.getElementById('backHomeBtn').onclick=()=>{ currentMainId=null; renderHome(); };
document.getElementById('addSubBtn').onclick=()=>{
  const main=db.topics.find(t=>t.id===currentMainId); if(!main) return;
  const name=prompt('ชื่อหัวข้อย่อย'); if(!name) return;
  // init with 3 tiers default
  main.subs.push({id:uid(), name:name.trim(), tiers:[{name:'Beginner',bars:5},{name:'Intermediate',bars:6},{name:'Advanced',bars:7}], segs:6, quests:[], history:[]});
  saveDB(); openMain(currentMainId);
};
document.getElementById('deleteMainBtn').onclick=()=>{
  const i=db.topics.findIndex(t=>t.id===currentMainId); if(i<0) return; if(!confirm('ลบหัวข้อหลักนี้และทุกอย่างภายใน?'))return;
  db.topics.splice(i,1); saveDB(); currentMainId=null; renderHome();
};
document.getElementById('backMainBtn').onclick=()=>openMain(currentMainId);
document.getElementById('deleteSubBtn').onclick=()=>{
  const main=db.topics.find(t=>t.id===currentMainId);
  if(!confirm('ลบหัวข้อย่อยนี้และข้อมูลทั้งหมด?'))return;
  main.subs = main.subs.filter(s=>s.id!==currentSubId); saveDB(); openMain(currentMainId);
};

/* ===== INIT ===== */
function start(){
  renderHome();
  window.addEventListener('resize', ()=>{
    drawRadarOn('radarCanvas', db.topics.map(t=>t.name), db.topics.map(t=>mainPercent(t)),'ค่าเฉลี่ย % ของแต่ละหัวข้อหลัก');
  });
}
window.addEventListener('DOMContentLoaded', start);
</script>
</body>
</html>
