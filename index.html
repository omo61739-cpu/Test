<<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Progressive Self-Development — Tiered</title>
<style>
  :root{
    /* ===== Dark+Blue Theme ===== */
    --bg:#0b1020;
    --bg-2:#0f1529;
    --card:#0f162e;
    --card-2:#121a36;
    --ink:#e5ecff;
    --muted:#8fa2d6;
    --accent:#3b82f6;      /* blue */
    --accent-2:#22d3ee;    /* cyan */
    --danger:#ef4444;
    --border:#1f2a48;
    --ring:0 8px 30px rgba(0,10,40,.35);
    --shadow-strong:0 18px 60px rgba(5,10,30,.55);

    /* bar skins */
    --skin-basic:linear-gradient(90deg,#5177ff,#2a53ff);
    --skin-silver:linear-gradient(90deg,#d0d4e3,#a1a7bf);
    --skin-gold:linear-gradient(90deg,#ffd36e,#ffac33);
    --skin-diamond:linear-gradient(90deg,#7ef9ff,#5eb8ff);

    --glass:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1000px 700px at 80% -10%,#14204a 0%,transparent 60%), var(--bg);
       color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  a{color:var(--accent)}
  .container{max-width:1060px;margin:0 auto;padding:18px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
  h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.1px}
  .btn{border:0;border-radius:12px;padding:10px 14px;font-size:14px;cursor:pointer;background:var(--accent);color:#fff;transition:.15s;box-shadow:var(--ring)}
  .btn:hover{filter:brightness(1.05)}
  .btn.secondary{background:#1b2340;color:#cfe1ff;border:1px solid var(--border)}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
  .btn.success{background:linear-gradient(90deg,#12b981,#06b6d4)}
  .btn.danger{background:linear-gradient(90deg,#f97316,#ef4444)}
  .btn.warn{background:linear-gradient(90deg,#f59e0b,#f97316)}
  .btn.small{padding:6px 10px;border-radius:10px;font-size:12px}
  .grid{display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--border);
        border-radius:16px;padding:14px;box-shadow:var(--ring);backdrop-filter:saturate(1.1) blur(2px)}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"],input[type="number"],textarea,select{
    width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:#0b142d;color:var(--ink)
  }
  textarea{min-height:70px;resize:vertical}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .right{margin-left:auto}
  .small{font-size:12px;color:var(--muted)}
  .spacer{height:8px}
  .wrap{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .hr{height:1px;background:linear-gradient(90deg,transparent,#223058,transparent);margin:10px 0}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#cde0ff;background:rgba(34,48,88,.45)}
  .muted{color:#9eb4ef}

  /* ===== Home cards ===== */
  .topic-card{display:flex;gap:12px;align-items:center;cursor:pointer}
  .topic-name{flex:0 0 250px;font-weight:700}
  .mini{font-size:11px;color:#9fb1e2}

  /* ===== Bars (segments) ===== */
  .segbar{position:relative;height:18px;border-radius:12px;overflow:hidden;
          border:1px solid #27355e;background:linear-gradient(180deg,#0e1731,#0a1126)}
  .segbar .fill{position:absolute;left:0;top:0;height:100%;background:var(--skin-basic)}
  .segbar .ticks{position:absolute;inset:0;display:flex;gap:0}
  .segbar .ticks i{flex:1;border-right:1px solid rgba(255,255,255,.08)}
  .segbar.gold .fill{background:var(--skin-gold);box-shadow:0 0 10px rgba(255,200,60,.35) inset}
  .segbar.silver .fill{background:var(--skin-silver)}
  .segbar.diamond .fill{background:var(--skin-diamond);box-shadow:0 0 16px rgba(120,220,255,.4)}
  .segbar.basic .fill{background:var(--skin-basic)}
  .badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);padding:4px 8px;border-radius:999px;background:#0b142d}

  /* ===== Circle average ===== */
  .circle-wrapper{display:flex;justify-content:center;align-items:center;margin:12px 0 8px 0;position:relative}
  svg{transform:rotate(-90deg)}
  .circle-text{position:absolute;font-size:17px;font-weight:800}

  /* ===== Tier header (Sub page) ===== */
  .tier-hero{display:grid;grid-template-columns:1fr 1.4fr 1fr;gap:14px;align-items:center}
  .img-wrap{display:flex;justify-content:center;align-items:center}
  .img-frame{
    background:var(--glass);border:1px solid var(--border);border-radius:14px;padding:10px;display:inline-block;
    box-shadow:var(--ring)
  }
  .img-frame.final{grid-column:1 / span 3;justify-self:center}
  .img-frame img{display:block;max-width:100%;height:auto;border-radius:10px}
  .tier-title{font-weight:800}
  .tier-name{font-size:12px;color:#cdd8ff}
  .next-label{font-size:12px;color:#99aee8}
  .center-col{display:flex;flex-direction:column;gap:8px}

  /* ===== Quest cards ===== */
  .quest{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .quest .meta{display:flex;flex-direction:column;gap:4px}
  .quest .condition{font-size:12px;color:#9fb1e2}
  .quest .controls{display:flex;gap:6px}
  .quest .controls .btn{padding:8px 10px}

  /* ===== Modal base ===== */
  .modal{position:fixed;inset:0;background:rgba(2,6,22,.7);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .dialog{width:min(980px,calc(100% - 24px));max-height:90vh;background:var(--card-2);border:1px solid var(--border);border-radius:16px;
          box-shadow:var(--shadow-strong);display:flex;flex-direction:column;overflow:hidden}
  .dialog header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
  .dialog main{padding:14px;overflow:auto}
  .dialog footer{padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;background:#0b142d;position:sticky;bottom:0}

  /* ===== Setup forms ===== */
  .tier-grid{display:grid;grid-template-columns:.9fr .8fr .6fr .7fr .7fr .6fr;gap:10px;align-items:end}
  .tier-grid .thumb{display:flex;align-items:end;gap:8px}
  .tier-grid .thumb input[type="file"]{width:100%}
  .thumb .preview{border:1px dashed var(--border);border-radius:12px;padding:6px;min-height:46px;display:flex;justify-content:center;align-items:center}
  .thumb .preview img{max-width:100%;max-height:60px;border-radius:8px}

  /* Responsive tweak */
  @media (max-width:900px){
    .tier-hero{grid-template-columns:1fr}
    .img-frame.final{grid-column:auto}
    .tier-grid{grid-template-columns:1fr 1fr 1fr}
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="wrap">
      <h1>Progressive Self-Development</h1>
      <span class="pill">v3 • Tiered</span>
    </div>
    <div class="wrap">
      <button class="btn" id="addTopicBtn">เพิ่มหัวข้อหลัก</button>
      <button class="btn secondary" id="exportBtn">ส่งออกข้อมูลทั้งหมด</button>
    </div>
  </header>

  <!-- Average circle -->
  <div class="circle-wrapper">
    <svg width="98" height="98">
      <circle cx="49" cy="49" r="44" stroke="#1f2a48" stroke-width="10" fill="none"/>
      <circle id="progressCircle" cx="49" cy="49" r="44" stroke="#3b82f6" stroke-width="10" fill="none"
              stroke-linecap="round" stroke-dasharray="276.46" stroke-dashoffset="276.46"/>
    </svg>
    <div class="circle-text" id="circleText">0%</div>
  </div>

  <!-- Home — radar ตัดทิ้งเพื่อความคล่องตัว/โหลดไว (ถ้าต้องการเพิ่มภายหลังทำได้) -->
  <section id="homeView" class="grid">
    <div class="card"><div class="small">แตะหัวข้อหลักเพื่อเข้าไปดูหัวข้อย่อยและความคืบหน้าโดยรวม</div></div>
    <div id="topicsList" class="grid"></div>
  </section>

  <!-- Main topic -->
  <section id="mainView" class="grid" style="display:none">
    <div class="card">
      <div class="row" style="align-items:center">
        <button class="btn ghost" id="backHomeBtn">← กลับหน้าแรก</button>
        <h2 id="mainTitle" style="margin:0"></h2>
        <span class="right small" id="mainSummary"></span>
        <button class="btn danger" id="deleteMainBtn">ลบหัวข้อหลัก</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <div class="wrap" style="font-weight:700">หัวข้อย่อย</div>
        <button class="btn secondary right" id="addSubBtn">เพิ่มหัวข้อย่อย (ตั้งค่า Tier)</button>
      </div>
      <div id="subsList" class="grid" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Sub topic -->
  <section id="subView" class="grid" style="display:none">
    <div class="card">
      <div class="row" style="align-items:center">
        <button class="btn ghost" id="backMainBtn">← กลับหัวข้อหลัก</button>
        <h2 id="subTitle" style="margin:0"></h2>
        <div class="right wrap">
          <button class="btn secondary small" id="editSubTierBtn">แก้ไขการตั้งค่า Tier</button>
          <button class="btn warn small" id="addQuestBtn">เพิ่ม Quest</button>
          <button class="btn danger small" id="deleteSubBtn">ลบหัวข้อย่อย</button>
        </div>
      </div>
    </div>

    <!-- Tier header -->
    <div class="card">
      <div id="tierHero" class="tier-hero">
        <!-- จะถูกเรนเดอร์ด้วย JS -->
      </div>
    </div>

    <!-- Quests -->
    <div class="card">
      <div class="row" style="align-items:center">
        <div style="font-weight:800">Quests</div>
      </div>
      <div id="questsList" class="grid" style="margin-top:8px"></div>
    </div>
  </section>
</div>

<!-- ========== Modal: New Sub (Tier Setup Wizard) ========== -->
<div id="subSetupModal" class="modal" aria-hidden="true">
  <div class="dialog">
    <header>
      <div><b>สร้าง/แก้ไขหัวข้อย่อย</b><div class="small">ตั้งค่า Tier ทั้งหมด รูป, ชื่อ, จำนวนช่อง, เงื่อนไขการเลื่อนขั้น</div></div>
      <button class="btn ghost" id="ssmClose">ปิด</button>
    </header>
    <main>
      <div class="grid">
        <div class="card" style="background:#0b142d">
          <div class="row">
            <div style="flex:1">
              <label>ชื่อหัวข้อย่อย</label>
              <input type="text" id="ssmName" placeholder="เช่น Emotional Regulation (ER)"/>
            </div>
            <div style="width:180px">
              <label>จำนวน Tier</label>
              <input type="number" id="ssmTierCount" min="1" max="8" value="3"/>
            </div>
          </div>
          <div class="spacer"></div>
          <div class="small">สำหรับ “ภาพของ Tier” เก็บไว้ในเบราว์เซอร์ (localStorage) — ไม่ต้องมีเซิร์ฟเวอร์</div>
        </div>

        <div class="card">
          <div class="tier-grid" id="ssmTierGrid">
            <!-- rows generated -->
          </div>
        </div>
      </div>
    </main>
    <footer>
      <button class="btn ghost" id="ssmCancel">ยกเลิก</button>
      <button class="btn success" id="ssmSave">บันทึก</button>
    </footer>
  </div>
</div>

<!-- ========== Modal: Quest Setup ========== -->
<div id="questSetupModal" class="modal" aria-hidden="true">
  <div class="dialog">
    <header>
      <div><b>ตั้งค่า Quest</b><div class="small">กำหนด Tier, จำนวนช่อง/เงื่อนไข และข้อความเงื่อนไขต่อ Tier</div></div>
      <button class="btn ghost" id="qsmClose">ปิด</button>
    </header>
    <main>
      <div class="row">
        <div style="flex:1">
          <label>ชื่อ Quest</label>
          <input type="text" id="qsmName" placeholder="เช่น ทำสมาธิ 10 นาที"/>
        </div>
        <div style="width:160px">
          <label>จำนวน Tier</label>
          <input type="number" id="qsmTierCount" min="1" max="8" value="3"/>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="card">
        <div id="qsmGrid" class="grid" style="gap:8px">
          <!-- rows generated -->
        </div>
      </div>
    </main>
    <footer>
      <button class="btn ghost" id="qsmCancel">ยกเลิก</button>
      <button class="btn success" id="qsmSave">บันทึก</button>
    </footer>
  </div>
</div>

<script>
/* =========================
   Storage & Migration
========================= */
const DB_V2_KEY = 'psd_v2_nested';      // เก่า (points)
const DB_V3_KEY = 'psd_v3_tiered';      // ใหม่ (tiers)

function nowISO(){ return new Date().toISOString(); }
function uid(){ return 'id'+Math.random().toString(36).slice(2,10); }
function loadV3(){ try{const raw=localStorage.getItem(DB_V3_KEY); return raw?JSON.parse(raw):null }catch{return null} }
function saveV3(db){ localStorage.setItem(DB_V3_KEY, JSON.stringify(db)); }
function loadV2(){ try{const raw=localStorage.getItem(DB_V2_KEY); return raw?JSON.parse(raw):null }catch{return null} }
function backup(name, data){ localStorage.setItem(name, JSON.stringify(data)); }

let db = loadV3();
if(!db){
  // try migrate
  const old = loadV2();
  if(old && old.topics){
    // ทำสำเนาเก็บไว้
    backup('psd_backup_'+nowISO(), old);
    // สร้างโครง v3
    db = {version:3, topics:[]};
    for(const t of old.topics){
      const main = { id: t.id || uid(), name: t.name || 'หัวข้อหลัก', subs: [] };
      for(const s of (t.subs || [])){
        // คำนวณเปอร์เซ็นต์เดิม
        const percent = (()=> {
          const settings = (s.settings||{maxPoints:100,pointsPerStat:10});
          const trans = s.transactions||[];
          const total = trans.reduce((a,b)=>a + Number(b.delta||0), 0);
          const mp = Number(settings.maxPoints)||100;
          return mp? Math.max(0, Math.min(1, total/mp)) : 0;
        })();
        // แปลงเป็น Quest เดียวชื่อ Legacy Progress
        const qTiers = 3;
        const segmentsPerTier = 10;
        const pos = percent * qTiers;
        const qTierIndex = Math.min(qTiers-1, Math.floor(pos));
        const qFill = Math.round((pos - qTierIndex) * segmentsPerTier);

        const quest = {
          id: uid(),
          title: 'Legacy Progress',
          plan: { totalTiers:qTiers, tiers: Array.from({length:qTiers},(_,i)=>({
            title: ['Beginner','Intermediate','Advanced'][i] || ('Tier '+(i+1)),
            segments: segmentsPerTier,
            threshold: segmentsPerTier,
            condition: i===0?'ทำตามแผนพื้นฐาน':'พัฒนาต่อเนื่อง',
            style: tierStyleName(i)
          }))},
          state: { tierIndex: qTierIndex, filled: qFill }
        };

        const sub = {
          id: s.id || uid(),
          name: s.name || 'หัวข้อย่อย',
          tierPlan: {
            totalTiers:3,
            tiers: Array.from({length:3},(_,i)=>({
              title: ['Beginner','Intermediate','Advanced'][i] || ('Tier '+(i+1)),
              segments: 10,
              threshold: 10,
              image: null, imgScale: 1,
              style: tierStyleName(i)
            }))
          },
          quests:[quest],
          legacy: { settings: s.settings||{}, transactions: s.transactions||[], quests: s.quests||[] }
        };
        main.subs.push(sub);
      }
      db.topics.push(main);
    }
    saveV3(db);
  }else{
    db = {version:3, topics:[]};
    saveV3(db);
  }
}

/* =========================
   Helpers
========================= */
function tierStyleName(idx){
  return idx>=3 ? 'diamond' : (idx===2 ? 'gold' : (idx===1 ? 'silver' : 'basic'));
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

/* Quest normalized progress [0..1] */
function questNorm(q){
  const total = Math.max(1, q.plan.totalTiers||q.plan.tiers.length||1);
  const ti = clamp(q.state.tierIndex, 0, total-1);
  const seg = Math.max(1, q.plan.tiers[ti]?.segments || 1);
  const fill = clamp(q.state.filled, 0, seg);
  return (ti + (fill/seg)) / total;
}

/* Sub normalized progress = average of quests */
function subNorm(sub){
  const quests = sub.quests||[];
  if(!quests.length) return 0;
  let sum=0; quests.forEach(q=> sum += questNorm(q));
  return sum/quests.length;
}

/* Overall Sub visual (tierIndex + within-tier progress) derived from average progress */
function subVisualState(sub){
  const plan = sub.tierPlan;
  const total = plan.totalTiers || (plan.tiers?.length||1);
  const pos = subNorm(sub) * total;                  // 0..total
  let ti = Math.floor(pos);
  if(ti >= total) ti = total-1;
  const within = clamp(pos - ti, 0, 0.999);          // 0..1
  const seg = Math.max(1, plan.tiers[ti]?.segments || 1);
  const filled = Math.round(within * seg);
  return { tierIndex: ti, filled, seg, total };
}

/* Pretty percent for home average circle */
function homeAveragePercent(){
  const mains = db.topics||[];
  if(!mains.length) return 0;
  let sum=0, count=0;
  mains.forEach(m=>{
    const subs=m.subs||[];
    if(!subs.length) return;
    let local=0;
    subs.forEach(s=> local += subNorm(s));
    sum += (local / subs.length);
    count++;
  });
  if(count===0) return 0;
  return Math.round((sum/count)*100);
}

/* UI pieces */
function segbarHTML(segments, fill, skinClass='basic'){
  segments = Math.max(1, segments|0);
  fill = clamp(fill, 0, segments);
  const pct = (fill/segments)*100;
  const ticks = Array.from({length:segments},()=>'<i></i>').join('');
  return `<div class="segbar ${skinClass}">
    <div class="fill" style="width:${pct}%"></div>
    <div class="ticks">${ticks}</div>
  </div>`;
}

/* =========================
   DOM refs
========================= */
const homeView = document.getElementById('homeView');
const mainView = document.getElementById('mainView');
const subView  = document.getElementById('subView');
const topicsList = document.getElementById('topicsList');

const addTopicBtn = document.getElementById('addTopicBtn');
const exportBtn   = document.getElementById('exportBtn');

const backHomeBtn  = document.getElementById('backHomeBtn');
const mainTitle    = document.getElementById('mainTitle');
const mainSummary  = document.getElementById('mainSummary');
const deleteMainBtn= document.getElementById('deleteMainBtn');
const addSubBtn    = document.getElementById('addSubBtn');
const subsList     = document.getElementById('subsList');

const backMainBtn  = document.getElementById('backMainBtn');
const subTitle     = document.getElementById('subTitle');
const editSubTierBtn = document.getElementById('editSubTierBtn');
const deleteSubBtn = document.getElementById('deleteSubBtn');
const addQuestBtn  = document.getElementById('addQuestBtn');
const tierHero     = document.getElementById('tierHero');
const questsList   = document.getElementById('questsList');

/* Circle */
function updateCircle(){
  const circle=document.getElementById('progressCircle');
  const text=document.getElementById('circleText');
  const avg = homeAveragePercent();
  const C = 276.46;
  circle.style.strokeDashoffset = C - (C*(avg/100));
  text.textContent = avg+'%';
}

/* =========================
   Render: Home / Main / Sub
========================= */
let currentMainId=null, currentSubId=null;

function renderHome(){
  homeView.style.display='grid'; mainView.style.display='none'; subView.style.display='none';
  topicsList.innerHTML='';
  if(!db.topics.length){
    const empty=document.createElement('div'); empty.className='card';
    empty.innerHTML='<div class="small">ยังไม่มีหัวข้อหลัก • กด “เพิ่มหัวข้อหลัก” เพื่อเริ่มต้น</div>';
    topicsList.appendChild(empty);
  }else{
    db.topics.forEach(t=>{
      const card=document.createElement('div'); card.className='card topic-card';
      // percent ของหัวข้อหลัก = เฉลี่ยของ subNorm
      let p=0; if(t.subs && t.subs.length){ let s=0; t.subs.forEach(x=>s+=subNorm(x)); p=Math.round((s/t.subs.length)*100); }
      card.innerHTML = `
        <div class="topic-name">${t.name}</div>
        <div style="flex:1">${segbarHTML(10, Math.round(p/10), p>=80?'diamond':(p>=60?'gold':(p>=30?'silver':'basic'))}</div>
        <div class="mini" style="width:160px;text-align:right">${p}% • ${t.subs?.length||0} ย่อย</div>
        <button class="btn ghost small del-main">ลบ</button>
      `;
      card.addEventListener('click',()=>openMain(t.id));
      card.querySelector('.del-main').addEventListener('click',e=>{
        e.stopPropagation();
        if(!confirm(`ลบ "${t.name}" พร้อมหัวข้อย่อยทั้งหมด?`)) return;
        db.topics = db.topics.filter(x=>x.id!==t.id);
        saveV3(db); renderHome(); updateCircle();
      });
      topicsList.appendChild(card);
    });
  }
  updateCircle();
}

function openMain(id){
  currentMainId = id; currentSubId=null;
  const main = db.topics.find(t=>t.id===id);
  homeView.style.display='none'; mainView.style.display='grid'; subView.style.display='none';
  mainTitle.textContent = main.name;
  let p=0; if(main.subs?.length){ let s=0; main.subs.forEach(x=>s+=subNorm(x)); p=Math.round((s/main.subs.length)*100); }
  mainSummary.textContent = `ความคืบหน้าเฉลี่ย: ${p}% • ${main.subs?.length||0} ย่อย`;

  subsList.innerHTML='';
  if(!main.subs?.length){
    const empty=document.createElement('div'); empty.className='small'; empty.textContent='ยังไม่มีหัวข้อย่อย';
    subsList.appendChild(empty);
  }else{
    main.subs.forEach(sub=>{
      const vis = subVisualState(sub);
      const tier = (sub.tierPlan.tiers||[])[vis.tierIndex] || {};
      const skin = tier.style || tierStyleName(vis.tierIndex);
      const img = tier.image ? `<img src="${tier.image}" alt="" style="width:54px;height:auto;border-radius:8px">` : `<div class="small muted">No Image</div>`;
      const card=document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="row" style="align-items:center">
          <div class="img-frame" style="padding:6px">${img}</div>
          <div style="flex:1;min-width:240px">
            <div class="tier-title">${sub.name}</div>
            <div class="tier-name small">Tier ${vis.tierIndex+1}/${vis.total} — ${tier.title||('Tier '+(vis.tierIndex+1))}</div>
            <div style="margin-top:6px">${segbarHTML(vis.seg, vis.filled, skin)}</div>
          </div>
          <div class="right wrap">
            <button class="btn secondary small open-sub">เปิด</button>
            <button class="btn ghost small edit-sub">ตั้งค่า</button>
          </div>
        </div>`;
      card.querySelector('.open-sub').onclick=()=>openSub(sub.id);
      card.querySelector('.edit-sub').onclick=()=>openSubTierSetup(sub.id);
      subsList.appendChild(card);
    });
  }
}

backHomeBtn.onclick = ()=>{ currentMainId=null; renderHome(); };
deleteMainBtn.onclick = ()=>{
  if(!currentMainId) return;
  const i = db.topics.findIndex(t=>t.id===currentMainId);
  if(i<0) return;
  if(!confirm(`ลบ "${db.topics[i].name}" พร้อมข้อมูลทั้งหมด?`)) return;
  db.topics.splice(i,1); saveV3(db); currentMainId=null; renderHome();
};
addSubBtn.onclick = ()=> openSubTierSetup(null/*new sub*/);

function openSub(subId){
  currentSubId=subId;
  const main = db.topics.find(t=>t.id===currentMainId);
  const sub  = main.subs.find(s=>s.id===subId);
  subTitle.textContent = `${main.name} › ${sub.name}`;
  homeView.style.display='none'; mainView.style.display='none'; subView.style.display='grid';
  renderSubTierHero(); renderQuests();
}
backMainBtn.onclick = ()=> openMain(currentMainId);

/* Sub tier top hero */
function renderSubTierHero(){
  const main = db.topics.find(t=>t.id===currentMainId);
  const sub  = main.subs.find(s=>s.id===currentSubId);
  const vis = subVisualState(sub);
  const tiers = sub.tierPlan.tiers||[];
  const now  = tiers[vis.tierIndex] || {};
  const next = tiers[vis.tierIndex+1];

  const skin = now.style || tierStyleName(vis.tierIndex);
  const centerBar = segbarHTML(vis.seg, vis.filled, skin);

  // รูป: ปรับกรอบตามขนาดจริง + สเกล
  const imgNow  = now.image ? `<img src="${now.image}" style="transform:scale(${now.imgScale||1}); transform-origin:center">` : `<div class="small muted">No Image</div>`;
  const imgNext = next?.image ? `<img src="${next.image}" style="transform:scale(${next.imgScale||1}); transform-origin:center">` : `<div class="small muted">${next?'No Image':'—'}</div>`;

  if(!next){
    // final tier: เอารูปไว้ตรงกลาง
    tierHero.innerHTML = `
      <div class="img-wrap" style="grid-column:1 / span 3">
        <div class="img-frame final">${imgNow}</div>
      </div>
      <div class="center-col" style="grid-column:1 / span 3">
        <div class="tier-title">Tier ${vis.tierIndex+1}/${vis.total} — ${now.title||('Tier '+(vis.tierIndex+1))}</div>
        <div class="small">ถึง Tier สูงสุดแล้ว</div>
        ${centerBar}
      </div>
    `;
  }else{
    tierHero.innerHTML = `
      <div class="img-wrap">
        <div class="img-frame">${imgNow}</div>
      </div>
      <div class="center-col">
        <div class="tier-title">Tier ${vis.tierIndex+1}/${vis.total} — ${now.title||('Tier '+(vis.tierIndex+1))}</div>
        <div class="small next-label">ต่อไป: Tier ${vis.tierIndex+2} — ${next.title||('Tier '+(vis.tierIndex+2))}</div>
        ${centerBar}
      </div>
      <div class="img-wrap">
        <div class="img-frame">${imgNext}</div>
      </div>
    `;
  }
}

/* Quests list */
function renderQuests(){
  const main = db.topics.find(t=>t.id===currentMainId);
  const sub  = main.subs.find(s=>s.id===currentSubId);
  questsList.innerHTML='';
  if(!(sub.quests?.length)){
    const empty=document.createElement('div'); empty.className='small'; empty.textContent='ยังไม่มี Quest';
    questsList.appendChild(empty);
    return;
  }
  sub.quests.forEach(q=>{
    const ti = q.state.tierIndex;
    const t  = q.plan.tiers[ti] || {};
    const seg= Math.max(1, t.segments||1);
    const filled = clamp(q.state.filled,0,seg);
    const skin = t.style || tierStyleName(ti);
    const cond = t.condition || '—';

    const row=document.createElement('div'); row.className='card quest';
    row.innerHTML = `
      <div class="meta">
        <div class="wrap" style="gap:8px">
          <div style="font-weight:800">${q.title}</div>
          <span class="badge small">Tier ${ti+1}/${q.plan.totalTiers}</span>
        </div>
        <div class="condition">เงื่อนไข: ${cond}</div>
        <div style="margin-top:6px">${segbarHTML(seg, filled, skin)}</div>
      </div>
      <div class="controls">
        <button class="btn success small plus">+1</button>
        <button class="btn ghost small minus">−1</button>
        <button class="btn secondary small edit">ตั้งค่า</button>
        <button class="btn danger small del">ลบ</button>
      </div>
    `;

    row.querySelector('.plus').onclick=()=>{ questPlus(q); };
    row.querySelector('.minus').onclick=()=>{ questMinus(q); };
    row.querySelector('.edit').onclick=()=> openQuestSetup(q);
    row.querySelector('.del').onclick=()=>{
      if(!confirm('ลบ Quest นี้?')) return;
      sub.quests = sub.quests.filter(x=>x.id!==q.id);
      saveV3(db); renderQuests(); renderSubTierHero();
    };
    questsList.appendChild(row);
  });
}

function questPlus(q){
  const ti = q.state.tierIndex;
  const t  = q.plan.tiers[ti] || {};
  const seg= Math.max(1, t.segments||1);
  const threshold = clamp(t.threshold||seg, 1, seg);
  q.state.filled = clamp(q.state.filled+1, 0, seg);
  if(q.state.filled >= threshold && ti < q.plan.totalTiers-1){
    q.state.tierIndex += 1;
    q.state.filled = 0;
  }
  saveV3(db);
  renderQuests(); renderSubTierHero();
}
function questMinus(q){
  const ti = q.state.tierIndex;
  const t  = q.plan.tiers[ti] || {};
  const seg= Math.max(1, t.segments||1);
  if(q.state.filled>0){ q.state.filled -= 1; }
  else if(ti>0){
    // ย้อน tier
    const prev = q.plan.tiers[ti-1];
    const prevThreshold = clamp(prev.threshold||prev.segments||1,1,Math.max(1,prev.segments||1));
    q.state.tierIndex -= 1;
    q.state.filled = Math.max(0, prevThreshold-1);
  }
  saveV3(db);
  renderQuests(); renderSubTierHero();
}

/* Delete Sub */
deleteSubBtn.onclick = ()=>{
  if(!currentSubId) return;
  const main = db.topics.find(t=>t.id===currentMainId);
  const sub = main.subs.find(s=>s.id===currentSubId);
  if(!confirm(`ลบ "${sub.name}" ทั้งหมด?`)) return;
  main.subs = main.subs.filter(s=>s.id!==currentSubId);
  saveV3(db); openMain(currentMainId);
};

/* =========================
   Sub Setup Wizard (Create/Edit)
========================= */
const subSetupModal = document.getElementById('subSetupModal');
const ssmClose = document.getElementById('ssmClose');
const ssmCancel= document.getElementById('ssmCancel');
const ssmSave  = document.getElementById('ssmSave');
const ssmName  = document.getElementById('ssmName');
const ssmTierCount = document.getElementById('ssmTierCount');
const ssmTierGrid  = document.getElementById('ssmTierGrid');

let editingSubId = null; // null = create

function openSubTierSetup(subId){
  editingSubId = subId;
  const main = db.topics.find(t=>t.id===currentMainId);
  let sub = null;
  if(subId){
    sub = main.subs.find(s=>s.id===subId);
    ssmName.value = sub.name;
    ssmTierCount.value = sub.tierPlan.totalTiers||sub.tierPlan.tiers.length;
    buildTierRows(sub.tierPlan);
  }else{
    ssmName.value = '';
    ssmTierCount.value = 3;
    buildTierRows({totalTiers:3, tiers:defaultTierRows(3)});
  }
  subSetupModal.style.display='flex';
}
function closeSubTierSetup(){ subSetupModal.style.display='none'; }

function defaultTierRows(n){
  return Array.from({length:n},(_,i)=>({
    title: ['Beginner','Intermediate','Advanced','Master','Legend'][i] || ('Tier '+(i+1)),
    segments: 10, threshold:10, image:null, imgScale:1, style: tierStyleName(i)
  }));
}

function buildTierRows(plan){
  const n = Number(ssmTierCount.value||plan.totalTiers||plan.tiers.length||3);
  // normalize length
  let arr = (plan.tiers||defaultTierRows(n)).slice(0,n);
  while(arr.length<n) arr.push({title:'Tier '+(arr.length+1),segments:10,threshold:10,image:null,imgScale:1,style:tierStyleName(arr.length)});
  ssmTierGrid.innerHTML='';
  // header
  const header = document.createElement('div');
  header.className='tier-grid';
  header.innerHTML = `
    <div class="small">ภาพ & ขนาด</div>
    <div class="small">ชื่อ Tier</div>
    <div class="small">ช่อง</div>
    <div class="small">เกณฑ์เลื่อน</div>
    <div class="small">สเกลรูป</div>
    <div class="small">สกิน</div>
  `;
  ssmTierGrid.appendChild(header);

  arr.forEach((tier, idx)=>{
    const row=document.createElement('div'); row.className='tier-grid';
    row.innerHTML = `
      <div class="thumb">
        <div class="preview" id="prev_${idx}">${tier.image?`<img src="${tier.image}">`:'<span class="small muted">ไม่มีรูป</span>'}</div>
        <input type="file" accept="image/*" data-i="${idx}">
      </div>
      <div><input type="text" value="${tier.title||('Tier '+(idx+1))}" data-field="title" data-i="${idx}"></div>
      <div><input type="number" min="1" value="${tier.segments||10}" data-field="segments" data-i="${idx}"></div>
      <div><input type="number" min="1" value="${tier.threshold||tier.segments||10}" data-field="threshold" data-i="${idx}"></div>
      <div><input type="number" step="0.1" min="0.4" max="2" value="${tier.imgScale||1}" data-field="imgScale" data-i="${idx}"></div>
      <div>
        <select data-field="style" data-i="${idx}">
          <option value="basic" ${tier.style==='basic'?'selected':''}>Basic</option>
          <option value="silver" ${tier.style==='silver'?'selected':''}>Silver</option>
          <option value="gold" ${tier.style==='gold'?'selected':''}>Gold</option>
          <option value="diamond" ${tier.style==='diamond'?'selected':''}>Diamond</option>
        </select>
      </div>
    `;
    ssmTierGrid.appendChild(row);
  });

  // listeners
  ssmTierGrid.querySelectorAll('input[type="file"]').forEach(inp=>{
    inp.onchange = (e)=>{
      const i = Number(e.target.getAttribute('data-i'));
      const file = e.target.files?.[0]; if(!file) return;
      const r = new FileReader();
      r.onload = ()=>{
        const img = new Image();
        img.onload = ()=>{
          // store dataURL as-is
          const el = document.getElementById('prev_'+i);
          el.innerHTML = `<img src="${r.result}">`;
          el.setAttribute('data-src', r.result);
        };
        img.src = r.result;
      };
      r.readAsDataURL(file);
    }
  });
}
ssmTierCount.oninput = ()=> buildTierRows({tiers:defaultTierRows(Number(ssmTierCount.value||3))});
ssmClose.onclick = ssmCancel.onclick = closeSubTierSetup;

ssmSave.onclick = ()=>{
  const name = (ssmName.value||'').trim(); if(!name) return alert('กรุณาใส่ชื่อหัวข้อย่อย');
  const n = Number(ssmTierCount.value||3);
  // collect tiers
  const rows = [];
  // Collect by indexes from preview boxes
  for(let i=0;i<n;i++){
    const imgPrev = document.getElementById('prev_'+i);
    const img = imgPrev.getAttribute('data-src') || (imgPrev.querySelector('img')?.src || null);
    const title = ssmTierGrid.querySelector(`input[data-field="title"][data-i="${i}"]`).value || ('Tier '+(i+1));
    const segments = Math.max(1, Number(ssmTierGrid.querySelector(`input[data-field="segments"][data-i="${i}"]`).value)||10);
    let threshold = Number(ssmTierGrid.querySelector(`input[data-field="threshold"][data-i="${i}"]`).value)||segments;
    threshold = clamp(threshold,1,segments);
    const imgScale = Number(ssmTierGrid.querySelector(`input[data-field="imgScale"][data-i="${i}"]`).value)||1;
    const style = ssmTierGrid.querySelector(`select[data-field="style"][data-i="${i}"]`).value || tierStyleName(i);
    rows.push({title, segments, threshold, image:img, imgScale: clamp(imgScale,0.4,2), style});
  }
  const plan = { totalTiers:n, tiers:rows };

  const main = db.topics.find(t=>t.id===currentMainId);
  if(editingSubId){
    const sub = main.subs.find(s=>s.id===editingSubId);
    sub.name = name; sub.tierPlan = plan;
  }else{
    const sub = { id:uid(), name, tierPlan:plan, quests:[] };
    main.subs.push(sub);
  }
  saveV3(db); closeSubTierSetup();
  if(editingSubId) openMain(currentMainId); else openMain(currentMainId);
};

/* Shortcut from Sub page to edit */
editSubTierBtn.onclick = ()=>{
  const main = db.topics.find(t=>t.id===currentMainId);
  const sub  = main.subs.find(s=>s.id===currentSubId);
  openSubTierSetup(sub.id);
};

/* =========================
   Quest Setup Modal
========================= */
const qsm = document.getElementById('questSetupModal');
const qsmClose=document.getElementById('qsmClose');
const qsmCancel=document.getElementById('qsmCancel');
const qsmSave  =document.getElementById('qsmSave');
const qsmName  =document.getElementById('qsmName');
const qsmTierCount=document.getElementById('qsmTierCount');
const qsmGrid  =document.getElementById('qsmGrid');

let editingQuestId = null;

addQuestBtn.onclick = ()=> openQuestSetup(null);

function openQuestSetup(quest){
  editingQuestId = quest?.id || null;
  qsmName.value = quest?.title || '';
  qsmTierCount.value = quest?.plan?.totalTiers || 3;
  buildQuestRows(quest?.plan);
  qsm.style.display='flex';
}
function closeQuestSetup(){ qsm.style.display='none'; }

qsmClose.onclick = qsmCancel.onclick = closeQuestSetup;
qsmTierCount.oninput = ()=> buildQuestRows(null);

function buildQuestRows(plan){
  const n = Number(qsmTierCount.value|| plan?.totalTiers || 3);
  const arr = (plan?.tiers || Array.from({length:n},(_,i)=>({
    title: 'Tier '+(i+1),
    segments: 10,
    threshold: 10,
    condition: i===0?'เริ่มต้นจากพื้นฐาน':'พัฒนาขึ้น',
    style: tierStyleName(i)
  }))).slice(0,n);
  while(arr.length<n) arr.push({title:'Tier '+(arr.length+1),segments:10,threshold:10,condition:'—',style:tierStyleName(arr.length)});

  qsmGrid.innerHTML='';
  // header row
  const head=document.createElement('div'); head.className='row small'; head.style.cssText='color:#9fb1e2';
  head.innerHTML='<div style="flex:1">ชื่อ Tier</div><div style="width:110px">ช่อง</div><div style="width:140px">เกณฑ์เลื่อน</div><div style="width:130px">สกิน</div><div style="flex:1">เงื่อนไข</div>';
  qsmGrid.appendChild(head);

  arr.forEach((t,i)=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`
      <div style="flex:1"><input type="text" value="${t.title||('Tier '+(i+1))}" data-qf="title" data-i="${i}"></div>
      <div style="width:110px"><input type="number" min="1" value="${t.segments||10}" data-qf="segments" data-i="${i}"></div>
      <div style="width:140px"><input type="number" min="1" value="${t.threshold||t.segments||10}" data-qf="threshold" data-i="${i}"></div>
      <div style="width:130px">
        <select data-qf="style" data-i="${i}">
          <option value="basic" ${t.style==='basic'?'selected':''}>Basic</option>
          <option value="silver" ${t.style==='silver'?'selected':''}>Silver</option>
          <option value="gold" ${t.style==='gold'?'selected':''}>Gold</option>
          <option value="diamond" ${t.style==='diamond'?'selected':''}>Diamond</option>
        </select>
      </div>
      <div style="flex:1"><input type="text" value="${t.condition||''}" placeholder="ระบุเงื่อนไขของ Tier นี้" data-qf="condition" data-i="${i}"></div>
    `;
    qsmGrid.appendChild(row);
  });
}

qsmSave.onclick = ()=>{
  const name = (qsmName.value||'').trim(); if(!name) return alert('กรุณาใส่ชื่อ Quest');
  const n = Number(qsmTierCount.value||3);
  const tiers=[];
  for(let i=0;i<n;i++){
    const title = qsmGrid.querySelector(`input[data-qf="title"][data-i="${i}"]`).value || ('Tier '+(i+1));
    const segments = Math.max(1, Number(qsmGrid.querySelector(`input[data-qf="segments"][data-i="${i}"]`).value)||10);
    let threshold = Number(qsmGrid.querySelector(`input[data-qf="threshold"][data-i="${i}"]`).value)||segments;
    threshold = clamp(threshold,1,segments);
    const style = qsmGrid.querySelector(`select[data-qf="style"][data-i="${i}"]`).value || tierStyleName(i);
    const condition = qsmGrid.querySelector(`input[data-qf="condition"][data-i="${i}"]`).value || '';
    tiers.push({title,segments,threshold,style,condition});
  }
  const plan = { totalTiers:n, tiers };
  const main = db.topics.find(t=>t.id===currentMainId);
  const sub = main.subs.find(s=>s.id===currentSubId);

  if(editingQuestId){
    const q = sub.quests.find(x=>x.id===editingQuestId);
    q.title = name; q.plan = plan;
    // adjust state bounds
    q.state.tierIndex = clamp(q.state.tierIndex, 0, n-1);
    q.state.filled = clamp(q.state.filled, 0, Math.max(1, tiers[q.state.tierIndex].segments)-1);
  }else{
    sub.quests.push({ id:uid(), title:name, plan, state:{tierIndex:0, filled:0} });
  }
  saveV3(db); closeQuestSetup(); renderQuests(); renderSubTierHero();
};

/* =========================
   Topics add/export
========================= */
addTopicBtn.onclick = ()=>{
  const name = prompt('ชื่อหัวข้อหลัก (เช่น EQ)'); if(!name) return;
  db.topics.push({id:uid(), name:name.trim(), subs:[]});
  saveV3(db); renderHome();
};
exportBtn.onclick = ()=>{
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(db,null,2)],{type:'application/json'}));
  a.download='progress_tiered_backup.json';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href),800);
};

/* =========================
   Init
========================= */
function start(){
  renderHome();
  window.addEventListener('resize', updateCircle);
}
document.addEventListener('DOMContentLoaded', start);
</script>
</body>
</html>
