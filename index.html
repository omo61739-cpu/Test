<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Progressive Self-Development (Tiers)</title>
<style>
  :root{
    --bg:#f6f7fb;--card:#ffffff;--ink:#0f1220;--muted:#6b7280;
    --accent:#2563eb;--accent-2:#10b981;--danger:#ef4444;--border:#e5e7eb;
    --ring:0 10px 30px rgba(15,18,32,.06);
    --gold:#f59e0b;--violet:#8b5cf6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:980px;margin:0 auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{font-size:20px;margin:0}
  .btn{border:0;border-radius:12px;padding:10px 14px;font-size:14px;cursor:pointer;background:var(--accent);color:#fff;transition:.15s;box-shadow:0 1px 1px rgba(0,0,0,.04)}
  .btn:hover{filter:brightness(.96)}
  .btn.secondary{background:#e5e7eb;color:#111}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
  .btn.success{background:var(--accent-2);color:#fff}
  .btn.danger{background:var(--danger);color:#fff}
  .btn.ghost-danger{background:transparent;border:1px solid var(--danger);color:var(--danger)}
  .grid{display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--ring)}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"],input[type="number"],textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff}
  textarea{min-height:72px;resize:vertical}
  .small{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .spacer{height:8px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#374151;background:#f9fafb}
  .wrap{display:flex;gap:12px;flex-wrap:wrap}
  .right{margin-left:auto}

  /* แผงภาพ + tier */
  .tier-stage{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center}
  .tier-visual{display:flex;align-items:center;justify-content:center;min-height:180px;border:1px dashed var(--border);border-radius:14px;background:#fafafa;position:relative;overflow:hidden}
  .tier-visual.center{grid-column:1/3}
  .tier-visual img{max-width:100%;max-height:260px;object-fit:contain;transform-origin:center center}
  .tier-tools{display:flex;gap:8px;flex-wrap:wrap}
  .tier-desc{white-space:pre-wrap}

  /* หลอดความคืบหน้าแบบสวยและเปลี่ยนสกินตาม tier */
  .progress{position:relative;height:18px;border-radius:999px;overflow:hidden;border:1px solid var(--border);background:#eef2ff}
  .progress .fill{position:absolute;inset:0 100% 0 0}
  .progress .ticks{position:absolute;inset:0;pointer-events:none}
  .progress .tick{position:absolute;top:-3px;bottom:-3px;width:1px;background:#e5e7f0}
  .skin-0 .fill{background:linear-gradient(90deg,#93c5fd,#60a5fa)}
  .skin-1 .fill{background:linear-gradient(90deg,#60a5fa,#2563eb)}
  .skin-2{border-color:#d1b45a;background:#fff7e6}
  .skin-2 .fill{background:linear-gradient(90deg,#facc15,#f59e0b)}
  .skin-3{border-color:#c4b5fd;background:#f5f3ff}
  .skin-3 .fill{background:linear-gradient(90deg,#a78bfa,#8b5cf6)}
  .skin-4{border-color:#06b6d4;background:#ecfeff}
  .skin-4 .fill{background:linear-gradient(90deg,#22d3ee,#06b6d4)}

  /* รายการค้างบันทึก */
  #pendingList{background:#f9fafb;border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:10px}
  #pendingList .item{display:flex;gap:8px;margin:4px 0;align-items:center}
  #pendingList .delta{min-width:86px;font-weight:700}

  /* ตารางประวัติ */
  table{width:100%;border-collapse:collapse;table-layout:fixed}
  th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:13px;vertical-align:top}
  th{color:var(--muted);font-weight:600}
  .note-cell{white-space:pre-wrap;word-break:break-word}

  /* Modal สำหรับใส่หมายเหตุ (พร้อมประวัติเควส) */
  .modal{position:fixed;inset:0;background:rgba(15,18,32,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:50}
  .dialog{width:min(820px,calc(100% - 24px));background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.18);overflow:hidden}
  .dialog header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
  .dialog .content{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;padding:14px}
  .hist{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fafafa;max-height:260px;overflow:auto}
  .hist h4{margin:0 0 6px 0;font-size:13px;color:#6b7280}
  .hist .entry{border-bottom:1px dashed #e5e7eb;padding:6px 0}
  .hist .entry:last-child{border-bottom:0}
  .dialog footer{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--border);background:#fafafa}

  /* ฟอร์มเพิ่มเควส */
  .quest-form{display:flex;gap:8px;align-items:end;background:#f9fafb;border:1px dashed var(--border);padding:10px;border-radius:12px;margin-top:10px}
  .quest-form .btn{padding:8px 12px}

  /* หน้ารายละเอียดหัวข้อย่อย */
  #detailView .note-card{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
  #detailView textarea{min-height:120px}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Progressive Self-Development</h1>
    <div class="wrap">
      <button class="btn" id="addTopicBtn">เพิ่มหัวข้อหลัก</button>
      <button class="btn secondary" id="exportAllBtn">ส่งออกข้อมูลทั้งหมด</button>
      <span class="pill" id="statusPill">v3 • Local (Tiers)</span>
    </div>
  </header>

  <!-- หน้าแรก -->
  <section id="homeView" class="grid">
    <div class="card"><div class="small">หน้าแรก • แตะหัวข้อหลักเพื่อเข้าไปจัดการหัวข้อย่อย • ค่ารวมคิดจากสัดส่วน Tier ปัจจุบันของแต่ละหัวข้อย่อย</div></div>
    <div id="topicsList" class="grid"></div>
  </section>

  <!-- หน้า Main ของหัวข้อหลัก -->
  <section id="mainView" class="grid" style="display:none">
    <div class="card">
      <div class="row">
        <button class="btn ghost" id="backHomeBtn">← กลับหน้าแรก</button>
        <h2 id="mainTitle" style="margin:0"></h2>
        <span class="right small" id="mainSummary"></span>
        <button class="btn danger" id="deleteMainBtn">ลบหัวข้อหลักนี้</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <div style="font-weight:700">หัวข้อย่อย</div>
        <button class="btn secondary right" id="addSubBtn">เพิ่มหัวข้อย่อย</button>
      </div>
      <div id="subsList" class="grid" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- หน้า Sub (Tier + Quests) -->
  <section id="subView" class="grid" style="display:none">
    <div class="card">
      <div class="row">
        <button class="btn ghost" id="backMainBtn">← กลับหัวข้อหลัก</button>
        <h2 id="subTitle" style="margin:0"></h2>
        <span class="right small" id="subLive"></span>
        <button class="btn secondary" id="openDetailBtn">รายละเอียด</button>
      </div>
    </div>

    <!-- แผงภาพ Tier + หลอดรวมของหัวข้อย่อย -->
    <div class="card">
      <div class="row" style="align-items:center">
        <div class="wrap">
          <button class="btn ghost" id="manageTiersBtn">จัดการ Tier</button>
        </div>
        <span class="right pill" id="tierBadge"></span>
      </div>

      <div id="tierStage" class="tier-stage">
        <!-- ภาพ / ควบคุมรูป -->
        <div id="tierVisual" class="tier-visual">
          <div class="small">ยังไม่ได้ตั้งรูป</div>
        </div>
        <div>
          <div class="tier-tools">
            <label class="small">เลือกรูป <input type="file" id="tierImageInput" accept="image/*"></label>
            <label class="small">ขนาดรูป <input type="range" id="imgScale" min="50" max="150" value="100"></label>
          </div>
          <div class="spacer"></div>
          <label>คำอธิบายของ Tier ปัจจุบัน</label>
          <textarea id="tierDesc"></textarea>
        </div>
      </div>

      <div class="spacer"></div>
      <div>
        <label>ความคืบหน้ารวมของหัวข้อย่อยนี้</label>
        <div id="subProgress" class="progress skin-0"><div class="fill"></div><div class="ticks"></div></div>
        <div class="small" id="subProgressMeta"></div>
      </div>
    </div>

    <!-- Quests -->
    <div class="card">
      <div class="row" style="align-items:center">
        <h3 style="margin:0">Quests</h3>
        <button class="btn secondary right" id="addQuestBtn">เพิ่ม Quest</button>
      </div>

      <!-- ฟอร์มเพิ่มเควส -->
      <div id="questForm" class="quest-form" style="display:none">
        <div style="flex:2">
          <label>ชื่อเควส</label>
          <input type="text" id="questName" placeholder="เช่น ฝึก X 10 นาที">
        </div>
        <div style="flex:1">
          <label>เพิ่ม/ลดต่อครั้ง (หน่วยหลอด) — ใส่ตาม Tier ปัจจุบัน</label>
          <input type="number" id="questInc" step="1" value="1">
        </div>
        <div style="flex:1">
          <label>เงื่อนไข/คำอธิบาย (optional)</label>
          <input type="text" id="questRule" placeholder="เช่น สำเร็จตามแผนวันนี้">
        </div>
        <div class="row" style="gap:6px">
          <button class="btn success" id="questSaveBtn">เพิ่ม</button>
          <button class="btn ghost" id="questCancelBtn">ยกเลิก</button>
        </div>
      </div>

      <div id="questsList" class="grid" style="margin-top:8px"></div>

      <div id="pendingList" style="display:none"></div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn success" id="applyStageBtn">Save (บันทึกการเปลี่ยนแปลง)</button>
        <button class="btn ghost" id="discardStageBtn">ยกเลิกการเปลี่ยนแปลง</button>
      </div>
    </div>

    <!-- ประวัติ -->
    <div class="card">
      <div class="row" style="align-items:center">
        <h3 style="margin:0">ประวัติ</h3>
        <button class="btn secondary right" id="exportCsvBtn">ส่งออก CSV</button>
      </div>
      <table id="historyTable">
        <colgroup>
          <col style="width:170px"><col style="width:auto"><col style="width:120px">
        </colgroup>
        <thead><tr><th>วัน/เวลา</th><th>รายละเอียด</th><th>Δ หน่วย</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card"><button class="btn danger" id="deleteSubBtn">ลบหัวข้อย่อยนี้</button></div>
  </section>

  <!-- หน้า “รายละเอียด” ของหัวข้อย่อย -->
  <section id="detailView" class="grid" style="display:none">
    <div class="card">
      <div class="row">
        <button class="btn ghost" id="backFromDetailBtn">← กลับหัวข้อย่อย</button>
        <h2 style="margin:0">รายละเอียดหัวข้อย่อย</h2>
        <button class="btn secondary right" id="addDetailNoteBtn">เพิ่มกล่องข้อความ</button>
      </div>
      <div id="detailNotes" class="grid" style="margin-top:8px"></div>
    </div>
  </section>
</div>

<!-- Modal: เพิ่มหมายเหตุของการกดเควส + ย้อนดูประวัติของเควสนั้น -->
<div id="noteModal" class="modal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true">
    <header>
      <div>
        <div class="small" id="nmPath">หัวข้อหลัก › ย่อย › เควส</div>
        <div style="font-weight:700" id="nmTitle"></div>
      </div>
      <button class="btn ghost" id="nmClose">ปิด</button>
    </header>
    <div class="content">
      <div>
        <label id="nmLabel">ใส่หมายเหตุ (ไม่บังคับ)</label>
        <textarea id="nmInput" placeholder="เช่น ทำครบตามเงื่อนไขวันนี้"></textarea>
      </div>
      <div class="hist">
        <h4>ประวัติเควสนี้</h4>
        <div id="nmHist"></div>
      </div>
    </div>
    <footer>
      <span class="small" id="nmDelta"></span>
      <button class="btn ghost" id="nmCancel">ยกเลิก</button>
      <button class="btn success" id="nmSave">บันทึกเข้า “ค้างบันทึก”</button>
    </footer>
  </div>
</div>

<script>
/* ========= Storage / Model (v3) ========= */
const DB_KEY_V3='psd_v3_tiers';
const LEGACY_V2='psd_v2_nested';

function nowISO(){return new Date().toISOString();}
function uid(){return 'id'+Math.random().toString(36).slice(2,10);}

/* โหลด v3 หากไม่มีลองแปลงจาก v2 */
function loadDB(){
  try{
    const raw=localStorage.getItem(DB_KEY_V3);
    if(raw) return JSON.parse(raw);
    // migrate (ง่าย ๆ): v2 -> v3
    const old=localStorage.getItem(LEGACY_V2);
    if(!old) return {version:3,topics:[]};
    const o=JSON.parse(old);
    const topics=(o.topics||[]).map(t=>({
      id:t.id||uid(), name:t.name||'Topic',
      subs:(t.subs||[]).map(s=>{
        const tx=(s.transactions||[]);
        // สร้าง tier เริ่มต้น 3 ชั้น
        const tiers=[
          {name:'Beginner', need:5, image:'', scale:100, desc:''},
          {name:'Intermediate', need:5, image:'', scale:100, desc:''},
          {name:'Advanced', need:5, image:'', scale:100, desc:''},
        ];
        return {
          id:s.id||uid(), name:s.name||'Sub',
          tiers, tierIndex:0, progress:0,
          quests:(s.quests||[]).map(q=>({id:q.id||uid(), title:q.title||'Quest', rule:'', inc:1})),
          notes:[], transactions: tx.map(r=>({time:r.time, note:r.note||'', delta: Number(r.delta||0), questId:r.questId||'', questTitle:r.questTitle||''}))
        };
      })
    }));
    const db={version:3,topics};
    localStorage.setItem(DB_KEY_V3, JSON.stringify(db));
    return db;
  }catch(e){ return {version:3,topics:[]}; }
}
function saveDB(db){ localStorage.setItem(DB_KEY_V3, JSON.stringify(db)); }
let db=loadDB();

/* ========= Utils ========= */
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function fmt(n){ return (Math.round(n*100)/100).toString(); }

/* เปอร์เซ็นต์ของหัวข้อย่อย: (tierIndex + สัดส่วนใน tier)/ (tiers-1) */
function subPercent(sub){
  const T=sub.tiers.length;
  if(T<=1) return sub.tierIndex>=0?100:0;
  if(sub.tierIndex>=T-1) return 100;
  const need=sub.tiers[sub.tierIndex].need||1;
  const frac=need? (sub.progress/need) : 0;
  return clamp(((sub.tierIndex + frac)/(T-1))*100, 0, 100);
}
function mainPercent(main){
  if(!main.subs || !main.subs.length) return 0;
  const ps=main.subs.map(subPercent);
  return ps.reduce((a,b)=>a+b,0)/ps.length;
}

/* ========= Views (Home/Main/Sub/Detail) ========= */
const homeView=document.getElementById('homeView');
const mainView=document.getElementById('mainView');
const subView=document.getElementById('subView');
const detailView=document.getElementById('detailView');
const topicsList=document.getElementById('topicsList');

const backHomeBtn=document.getElementById('backHomeBtn');
const mainTitle=document.getElementById('mainTitle');
const mainSummary=document.getElementById('mainSummary');
const deleteMainBtn=document.getElementById('deleteMainBtn');
const subsList=document.getElementById('subsList');
const addSubBtn=document.getElementById('addSubBtn');

const backMainBtn=document.getElementById('backMainBtn');
const subTitle=document.getElementById('subTitle');
const subLive=document.getElementById('subLive');
const openDetailBtn=document.getElementById('openDetailBtn');

const manageTiersBtn=document.getElementById('manageTiersBtn');
const tierBadge=document.getElementById('tierBadge');
const tierVisual=document.getElementById('tierVisual');
const tierImageInput=document.getElementById('tierImageInput');
const imgScale=document.getElementById('imgScale');
const tierDesc=document.getElementById('tierDesc');
const subProgress=document.getElementById('subProgress');
const subProgressMeta=document.getElementById('subProgressMeta');

const addQuestBtn=document.getElementById('addQuestBtn');
const questForm=document.getElementById('questForm');
const questName=document.getElementById('questName');
const questInc=document.getElementById('questInc');
const questRule=document.getElementById('questRule');
const questSaveBtn=document.getElementById('questSaveBtn');
const questCancelBtn=document.getElementById('questCancelBtn');
const questsList=document.getElementById('questsList');
const pendingList=document.getElementById('pendingList');
const applyStageBtn=document.getElementById('applyStageBtn');
const discardStageBtn=document.getElementById('discardStageBtn');
const exportCsvBtn=document.getElementById('exportCsvBtn');
const historyTableBody=document.querySelector('#historyTable tbody');
const deleteSubBtn=document.getElementById('deleteSubBtn');

/* Detail page controls */
const backFromDetailBtn=document.getElementById('backFromDetailBtn');
const addDetailNoteBtn=document.getElementById('addDetailNoteBtn');
const detailNotes=document.getElementById('detailNotes');

/* Modal note */
const noteModal=document.getElementById('noteModal');
const nmPath=document.getElementById('nmPath');
const nmTitle=document.getElementById('nmTitle');
const nmLabel=document.getElementById('nmLabel');
const nmInput=document.getElementById('nmInput');
const nmHist=document.getElementById('nmHist');
const nmDelta=document.getElementById('nmDelta');
const nmClose=document.getElementById('nmClose');
const nmCancel=document.getElementById('nmCancel');
const nmSave=document.getElementById('nmSave');

let currentMainId=null, currentSubId=null;
let stage={events:[]}; // {note, delta, questId, questTitle}

/* ---- Home ---- */
function renderHome(){
  homeView.style.display='grid'; mainView.style.display='none'; subView.style.display='none'; detailView.style.display='none';
  topicsList.innerHTML='';
  if(!db.topics.length){
    const card=document.createElement('div'); card.className='card';
    card.innerHTML='<div class="small">ยังไม่มีหัวข้อหลัก • กด “เพิ่มหัวข้อหลัก” ที่มุมขวาบน</div>';
    topicsList.appendChild(card);
  }else{
    db.topics.forEach(t=>{
      const p=mainPercent(t);
      const card=document.createElement('div'); card.className='card row';
      card.innerHTML=`
        <div style="font-weight:700">${t.name}</div>
        <div class="right" style="min-width:220px;width:40%">
          <div class="progress skin-1"><div class="fill" style="inset:0 ${100-p}% 0 0"></div></div>
          <div class="small" style="text-align:right;margin-top:4px">${fmt(p)}%</div>
        </div>
        <button class="btn ghost-danger del-main">ลบ</button>`;
      card.addEventListener('click',()=>openMain(t.id));
      card.querySelector('.del-main').addEventListener('click',e=>{
        e.stopPropagation();
        if(!confirm(`ลบ "${t.name}" พร้อมหัวข้อย่อยทั้งหมด?`)) return;
        db.topics=db.topics.filter(x=>x.id!==t.id); saveDB(db); renderHome();
      });
      topicsList.appendChild(card);
    });
  }
}

/* ---- Main ---- */
function openMain(id){
  currentMainId=id; currentSubId=null;
  const main=db.topics.find(t=>t.id===id); if(!main) return;
  homeView.style.display='none'; mainView.style.display='grid'; subView.style.display='none'; detailView.style.display='none';
  mainTitle.textContent=main.name;
  mainSummary.textContent=`ค่าเฉลี่ยรวม: ${fmt(mainPercent(main))}% • ${main.subs.length} ย่อย`;
  subsList.innerHTML='';
  if(!main.subs.length){
    const empty=document.createElement('div'); empty.className='small'; empty.textContent='ยังไม่มีหัวข้อย่อย';
    subsList.appendChild(empty);
  }else{
    main.subs.forEach(sub=>{
      const p=subPercent(sub);
      const row=document.createElement('div'); row.className='card row';
      row.innerHTML=`
        <div style="font-weight:600">${sub.name}</div>
        <span class="pill">Tier: ${sub.tiers[sub.tierIndex]?.name||'-'} (${sub.tierIndex+1}/${sub.tiers.length})</span>
        <div class="right" style="min-width:220px;width:40%">
          <div class="progress skin-0"><div class="fill" style="inset:0 ${100-p}% 0 0"></div></div>
          <div class="small" style="text-align:right;margin-top:4px">${fmt(p)}%</div>
        </div>`;
      row.addEventListener('click',()=>openSub(sub.id));
      subsList.appendChild(row);
    });
  }
}
backHomeBtn.addEventListener('click',()=>{ currentMainId=null; renderHome(); });
addSubBtn.addEventListener('click',()=>{
  const main=db.topics.find(t=>t.id===currentMainId); if(!main) return;
  const name=prompt('ชื่อหัวข้อย่อย'); if(!name) return;
  // ตั้งค่า Tier คร่าว ๆ ตอนสร้าง (แก้ไขทีหลังได้ที่ปุ่ม "จัดการ Tier")
  const tiers=[
    {name:'Beginner', need:5, image:'', scale:100, desc:''},
    {name:'Intermediate', need:5, image:'', scale:100, desc:''},
    {name:'Advanced', need:5, image:'', scale:100, desc:''},
  ];
  main.subs.push({id:uid(),name:name.trim(),tiers,tierIndex:0,progress:0,quests:[],notes:[],transactions:[]});
  saveDB(db); openMain(currentMainId);
});
deleteMainBtn.addEventListener('click',()=>{
  if(!currentMainId) return;
  const i=db.topics.findIndex(t=>t.id===currentMainId); if(i<0) return;
  const name=db.topics[i].name||'หัวข้อหลักนี้';
  if(!confirm(`ลบ "${name}" ทั้งหมด?`)) return;
  db.topics.splice(i,1); saveDB(db); currentMainId=null; renderHome();
});

/* ---- Sub ---- */
function openSub(subId){
  currentSubId=subId;
  const main=db.topics.find(t=>t.id===currentMainId);
  const sub=main.subs.find(s=>s.id===subId);
  homeView.style.display='none'; mainView.style.display='none'; subView.style.display='grid'; detailView.style.display='none';
  subTitle.textContent=`${main.name} › ${sub.name}`;
  subLive.textContent=`ค่า ณ ปัจจุบัน: ${fmt(subPercent(sub))}%`;
  stage={events:[]};
  renderTierPanel(); renderQuests(); renderPending(); renderHistory();
}
backMainBtn.addEventListener('click',()=>openMain(currentMainId));
openDetailBtn.addEventListener('click',()=>openDetail());

/* ----- Tier Panel ----- */
function currentSub(){ const m=db.topics.find(t=>t.id===currentMainId); return m?.subs.find(s=>s.id===currentSubId); }
function renderTierPanel(){
  const sub=currentSub(); if(!sub) return;
  const T=sub.tiers.length, k=sub.tierIndex, tier=sub.tiers[k];
  tierBadge.textContent = `Tier ${k+1}/${T} • ${tier?.name||'-'}`;
  // ภาพ
  tierVisual.classList.toggle('center', k===T-1);
  tierVisual.innerHTML='';
  if(tier?.image){
    const img=new Image(); img.src=tier.image; img.style.transform=`scale(${(tier.scale||100)/100})`;
    tierVisual.appendChild(img);
  }else{
    const d=document.createElement('div'); d.className='small'; d.textContent='ยังไม่ได้ตั้งรูป';
    tierVisual.appendChild(d);
  }
  imgScale.value = tier?.scale||100;
  tierDesc.value = tier?.desc||'';

  // หลอดรวม
  const skinIdx = Math.min(4, k); // ไล่สกินตาม tier
  subProgress.className = 'progress skin-'+skinIdx;
  const fill=subProgress.querySelector('.fill'), ticks=subProgress.querySelector('.ticks');
  let need=tier?.need||1;
  let frac=(k>=T-1)?1: clamp(sub.progress/(need||1),0,1);
  fill.style.inset=`0 ${100-(frac*100)}% 0 0`;
  ticks.innerHTML='';
  for(let i=1;i<need;i++){
    const tk=document.createElement('div'); tk.className='tick'; tk.style.left=(i*100/need)+'%'; ticks.appendChild(tk);
  }
  let meta = (k>=T-1) ? 'ถึง Tier สูงสุดแล้ว' : `ความคืบหน้า: ${sub.progress}/${need} หน่วย`;
  subProgressMeta.textContent = meta;
}
tierImageInput.addEventListener('change',e=>{
  const file=e.target.files?.[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    const sub=currentSub(); if(!sub) return; sub.tiers[sub.tierIndex].image = reader.result;
    saveDB(db); renderTierPanel();
  };
  reader.readAsDataURL(file);
});
imgScale.addEventListener('input',()=>{
  const sub=currentSub(); if(!sub) return; sub.tiers[sub.tierIndex].scale = Number(imgScale.value)||100; saveDB(db); renderTierPanel();
});
tierDesc.addEventListener('input',()=>{
  const sub=currentSub(); if(!sub) return; sub.tiers[sub.tierIndex].desc = tierDesc.value; saveDB(db);
});
manageTiersBtn.addEventListener('click',()=>{
  const sub=currentSub(); if(!sub) return;
  // ตัวจัดการ Tier แบบ prompt (เรียบง่ายแต่ครบ) — ชื่อ / need / สลับไปมา / เพิ่ม-ลบ
  const menu=`จัดการ Tier ของ "${sub.name}"\n\nรายการปัจจุบัน:\n`+sub.tiers.map((t,i)=>`${i+1}. ${t.name} • need=${t.need}`).join('\n')+
  `\n\nคำสั่ง:\n1) rename <idx>\n2) need <idx>\n3) add\n4) remove (ลบตัวสุดท้าย)\n5) goto <idx>\n\nพิมพ์คำสั่ง (เช่น "need 2") หรือกด Cancel`;
  const cmd=prompt(menu); if(!cmd) return;
  const [c,a]=cmd.split(/\s+/);
  if(c==='rename' && a){ const i=+a-1; if(sub.tiers[i]){ const name=prompt('ชื่อใหม่', sub.tiers[i].name); if(name){ sub.tiers[i].name=name.trim(); saveDB(db); } } }
  else if(c==='need' && a){ const i=+a-1; if(sub.tiers[i]){ const v=Number(prompt('ต้องใช้กี่หน่วยเพื่อขึ้น Tier ถัดไป', sub.tiers[i].need)); if(Number.isFinite(v)&&v>0){ sub.tiers[i].need=v; saveDB(db);} } }
  else if(c==='add'){ sub.tiers.push({name:`Tier ${sub.tiers.length+1}`, need:5, image:'', scale:100, desc:''}); saveDB(db); }
  else if(c==='remove'){ if(sub.tiers.length>1){ sub.tiers.pop(); sub.tierIndex=Math.min(sub.tierIndex, sub.tiers.length-1); saveDB(db);} }
  else if(c==='goto' && a){ const i=clamp(+a-1,0,sub.tiers.length-1); sub.tierIndex=i; sub.progress=0; saveDB(db); }
  renderTierPanel();
});

/* ---- Quest / Stage ---- */
function renderQuests(){
  const sub=currentSub(); if(!sub) return;
  questsList.innerHTML='';
  if(!sub.quests.length){
    const empty=document.createElement('div'); empty.className='small'; empty.textContent='ยังไม่มี Quest';
    questsList.appendChild(empty);
  }
  sub.quests.forEach(q=>{
    const row=document.createElement('div'); row.className='row'; row.style.alignItems='center';
    row.innerHTML=
      `<div style="flex:1"><div style="font-weight:600">${q.title}</div><div class="small">+/- ${q.inc||1} หน่วย • ${q.rule||''}</div></div>
       <div class="wrap">
         <button class="btn success">เขียว +</button>
         <button class="btn danger">แดง −</button>
         <button class="btn secondary">แก้ไข</button>
         <button class="btn ghost">ลบ</button>
       </div>`;
    const [bPlus,bMinus,bEdit,bDel]=row.querySelectorAll('button');
    bPlus.onclick = ()=> openNoteModal('plus', q);
    bMinus.onclick= ()=> openNoteModal('minus', q);
    bEdit.onclick  = ()=>{
      const title=prompt('แก้ชื่อเควส',q.title); if(title===null) return;
      let inc=prompt('เพิ่ม/ลดต่อครั้ง (หน่วย)', q.inc||1); if(inc===null) return;
      inc=Number(inc); if(!isFinite(inc)||inc<=0) return alert('กรุณาใส่ตัวเลข > 0');
      const rule=prompt('เงื่อนไข/คำอธิบาย (optional)', q.rule||''); q.title=(title||'').trim()||q.title; q.inc=inc; q.rule=(rule||'').trim(); saveDB(db); renderQuests();
    };
    bDel.onclick   = ()=>{ if(!confirm('ลบเควสนี้?')) return; sub.quests=sub.quests.filter(x=>x.id!==q.id); saveDB(db); renderQuests(); };
    questsList.appendChild(row);
  });
}
/* เพิ่ม/ยกเลิก Quest form */
addQuestBtn.addEventListener('click',()=>{ questForm.style.display = questForm.style.display==='none' ? 'flex' : 'none'; if(questForm.style.display==='flex') questName.focus(); });
questCancelBtn.addEventListener('click',()=>{ questName.value=''; questInc.value='1'; questRule.value=''; questForm.style.display='none'; });
questSaveBtn.addEventListener('click',()=>{
  const sub=currentSub(); if(!sub) return;
  const name=(questName.value||'').trim(); if(!name) return alert('กรุณาใส่ชื่อเควส');
  const inc=Number(questInc.value||1); if(!isFinite(inc)||inc<=0) return alert('ใส่หน่วยเป็นเลขบวก');
  sub.quests.push({id:uid(),title:name,inc,rule:(questRule.value||'').trim()});
  saveDB(db); questName.value=''; questInc.value='1'; questRule.value=''; questForm.style.display='none'; renderQuests();
});

/* รายการค้างบันทึก */
function renderPending(){
  if(!stage.events.length){ pendingList.style.display='none'; pendingList.innerHTML=''; return; }
  pendingList.style.display='block';
  let html='<div class="small" style="margin-bottom:6px">รายการค้างบันทึก</div>';
  stage.events.forEach((ev,idx)=>{
    html+= `<div class="item"><div class="delta">${ev.delta>0?'+':''}${ev.delta} หน่วย</div><div style="flex:1">${ev.note}</div><button class="btn ghost" data-i="${idx}">ยกเลิก</button></div>`;
  });
  pendingList.innerHTML=html;
  pendingList.querySelectorAll('button').forEach(b=>{
    b.onclick=()=>{ const i=+b.getAttribute('data-i'); stage.events.splice(i,1); renderPending(); };
  });
}

/* Modal ใส่หมายเหตุ + ประวัติเควส */
let modalQuest=null, modalDelta=0, modalAction='plus';
function openNoteModal(action, quest){
  modalQuest=quest; modalAction=action; modalDelta = (action==='plus'? +(quest.inc||1) : -(quest.inc||1));
  const main=db.topics.find(t=>t.id===currentMainId);
  const sub=main.subs.find(s=>s.id===currentSubId);
  nmPath.textContent = `${main.name} › ${sub.name}`;
  nmTitle.textContent = `${quest.title}`;
  nmLabel.textContent = action==='plus' ? 'ใส่หมายเหตุ (เพิ่มหน่วย)' : 'ใส่หมายเหตุ (ลดหน่วย)';
  nmDelta.textContent = `ผลกระทบครั้งนี้: ${modalDelta>0?'+':''}${modalDelta} หน่วย`;
  nmInput.value='';
  // ประวัติเควสนี้
  const hist = (sub.transactions||[]).filter(r=>r.questId===quest.id).slice(-30).reverse();
  nmHist.innerHTML = hist.length? hist.map(r=>{
      const d=new Date(r.time); return `<div class="entry"><div class="small">${d.toLocaleString()} • ${r.delta>0?'+':''}${r.delta}</div><div>${(r.note||'')}</div></div>`;
    }).join('') : '<div class="small">ยังไม่มีประวัติของเควสนี้</div>';
  noteModal.style.display='flex';
}
function closeNoteModal(){ noteModal.style.display='none'; }
[nmClose,nmCancel].forEach(b=>b.addEventListener('click',closeNoteModal));
noteModal.addEventListener('click',e=>{ if(e.target===noteModal) closeNoteModal(); });
nmSave.addEventListener('click',()=>{
  if(!modalQuest) return;
  const txt = nmInput.value.trim();
  const label = (modalAction==='plus')? `✔ ${modalQuest.title} (+${modalQuest.inc||1})` : `✖ ${modalQuest.title} (-${modalQuest.inc||1})`;
  const full = txt? `${label} — ${txt}` : label;
  stage.events.push({note:full, delta:modalDelta, questId:modalQuest.id, questTitle:modalQuest.title});
  closeNoteModal(); renderPending();
});

/* บันทึก/ยกเลิกการเปลี่ยนแปลง */
applyStageBtn.addEventListener('click',()=>{
  const sub=currentSub(); if(!sub) return;
  if(stage.events.length){
    let delta = stage.events.reduce((s,e)=>s+e.delta,0);
    // ปรับ progress + ข้าม/ถอย tier อัตโนมัติ (carry reset ตามสเปก)
    applyDeltaToSub(sub, delta);
    // เก็บประวัติทีละรายการ
    stage.events.forEach(ev=> sub.transactions.push({time:nowISO(),note:ev.note,delta:ev.delta,questId:ev.questId,questTitle:ev.questTitle}) );
  }
  saveDB(db);
  stage={events:[]};
  renderTierPanel(); renderPending(); renderHistory();
  subLive.textContent=`ค่า ณ ปัจจุบัน: ${fmt(subPercent(sub))}%`;
  alert('บันทึกแล้ว');
});
discardStageBtn.addEventListener('click',()=>{ stage={events:[]}; renderPending(); });

/* อัลกอริทึมอัปเดต progress/tier */
function applyDeltaToSub(sub, delta){
  let k=sub.tierIndex, T=sub.tiers.length;
  if(T===0) return;
  // เพิ่ม
  while(delta>0){
    if(k>=T-1){ sub.progress=0; break; } // ถึงสุดแล้ว
    const need=sub.tiers[k].need||1;
    const space = need - sub.progress;
    if(delta >= space){ // ขึ้น tier
      k++; sub.progress=0; delta -= space;
    }else{ sub.progress += delta; delta=0; }
  }
  // ลด
  while(delta<0){
    if(k<=0 && sub.progress<=0){ delta=0; sub.progress=0; break; }
    if(sub.progress + delta >= 0){ sub.progress += delta; delta=0; }
    else{ // ยืมจาก tier ก่อนหน้า
      delta += sub.progress;
      k--; const needPrev=sub.tiers[k].need||1;
      sub.progress = needPrev; // จะลดต่อในรอบถัดไป
    }
  }
  sub.tierIndex = clamp(k,0,T-1);
}

/* ประวัติ */
function renderHistory(){
  const sub=currentSub(); if(!sub) return;
  historyTableBody.innerHTML='';
  (sub.transactions||[]).slice().reverse().forEach(r=>{
    const tr=document.createElement('tr');
    const d=new Date(r.time);
    tr.innerHTML=`<td>${d.toLocaleString()}</td><td class="note-cell">${r.note||''}</td><td>${r.delta>0?'+':''}${r.delta}</td>`;
    historyTableBody.appendChild(tr);
  });
}
exportCsvBtn.addEventListener('click',()=>{
  const main=db.topics.find(t=>t.id===currentMainId); const sub=currentSub();
  const rows=[['time','note','delta','questId','questTitle']].concat((sub.transactions||[]).map(r=>[r.time,r.note||'',r.delta,r.questId||'',r.questTitle||'']));
  const csv=rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  download(`${main.name.replace(/\s+/g,'_')}__${sub.name.replace(/\s+/g,'_')}_history.csv`, csv);
});
deleteSubBtn.addEventListener('click',()=>{
  if(!confirm('ลบหัวข้อย่อยนี้และข้อมูลทั้งหมด?')) return;
  const main=db.topics.find(t=>t.id===currentMainId);
  main.subs=main.subs.filter(s=>s.id!==currentSubId); saveDB(db); openMain(currentMainId);
});

/* ---- Detail page ---- */
function openDetail(){
  const sub=currentSub(); if(!sub) return;
  subView.style.display='none'; detailView.style.display='grid';
  renderDetailNotes();
}
function renderDetailNotes(){
  const sub=currentSub(); if(!sub) return;
  detailNotes.innerHTML='';
  if(!(sub.notes&&sub.notes.length)){
    const n=document.createElement('div'); n.className='small'; n.textContent='ยังไม่มีข้อมูลรายละเอียด • กด "เพิ่มกล่องข้อความ"';
    detailNotes.appendChild(n);
  }else{
    sub.notes.forEach(note=>{
      const card=document.createElement('div'); card.className='note-card';
      card.innerHTML=`<div class="row"><div class="small">${new Date(note.time).toLocaleString()}</div><span class="right"></span></div>
        <textarea>${note.text||''}</textarea>
        <div class="row" style="margin-top:8px"><button class="btn success">บันทึก</button><button class="btn ghost">ลบ</button></div>`;
      const ta=card.querySelector('textarea'); const [bSave,bDel]=card.querySelectorAll('button');
      bSave.onclick=()=>{ note.text=ta.value; note.time=nowISO(); saveDB(db); alert('บันทึกแล้ว'); };
      bDel.onclick=()=>{ if(!confirm('ลบข้อมูลนี้?')) return; sub.notes=sub.notes.filter(x=>x.id!==note.id); saveDB(db); renderDetailNotes(); };
      detailNotes.appendChild(card);
    });
  }
}
backFromDetailBtn.addEventListener('click',()=>{ detailView.style.display='none'; subView.style.display='grid'; });
addDetailNoteBtn.addEventListener('click',()=>{
  const sub=currentSub(); if(!sub) return;
  sub.notes = sub.notes||[];
  sub.notes.unshift({id:uid(), time:nowISO(), text:''});
  saveDB(db); renderDetailNotes();
});

/* ====== Add / Export (Global) ====== */
document.getElementById('addTopicBtn').addEventListener('click',()=>{
  const name=prompt('ชื่อหัวข้อหลัก'); if(!name) return;
  db.topics.push({id:uid(),name:name.trim(),subs:[]}); saveDB(db); renderHome();
});
function download(filename,text){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename;
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}
document.getElementById('exportAllBtn').addEventListener('click',()=>download('progress_backup_v3_tiers.json', JSON.stringify(db,null,2)));

/* ===== Init ===== */
function start(){ renderHome(); }
window.addEventListener('DOMContentLoaded', start);
</script>
</body>
</html>
