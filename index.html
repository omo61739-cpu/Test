<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Progressive Self-Development — Tiered</title>
<style>
/* ===== Theme: Dark Navy + Glass ===== */
:root{
  --bg:#080d18; --bg-2:#0d1424; --panel:rgba(18,24,40,.66);
  --ink:#e7eeff; --muted:#93a4c7; --border:#1c2742; --ring:0 20px 60px rgba(0,0,0,.25);
  --accent:#4f8cff; --accent-2:#22d3ee; --danger:#ef4444; --ok:#10b981;
  --gold:#f8c425; --diamond:#8b5cf6; --myth:#06b6d4;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--ink);
  background:
    radial-gradient(1200px 600px at 80% -20%, #0b1933 0%, transparent 60%),
    radial-gradient(900px 600px at -10% 20%, #091733 0%, transparent 60%),
    linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
}
.container{max-width:1120px;margin:0 auto;padding:18px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:10px}
h1{margin:0;font-size:20px}
.pill{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--muted);font-size:12px}
.btn{border:1px solid transparent;border-radius:12px;padding:10px 14px;font-size:14px;cursor:pointer;color:#fff;background:linear-gradient(180deg,#5b8dff,#3b6efc);box-shadow:0 4px 18px rgba(79,140,255,.22);transition:.2s}
.btn:hover{filter:brightness(.98)}
.btn.secondary{background:rgba(255,255,255,.08);border-color:var(--border);color:var(--ink)}
.btn.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
.btn.success{background:linear-gradient(180deg,#25d6ae,#10b981)}
.btn.danger{background:linear-gradient(180deg,#ff6b6b,#ef4444)}
.grid{display:grid;gap:12px}
.card{
  background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:14px;
  backdrop-filter:blur(10px);box-shadow:var(--ring)
}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.wrap{display:flex;gap:10px;flex-wrap:wrap}
.right{margin-left:auto}
.hr{height:1px;background:linear-gradient(90deg,transparent, #1f2b4a, transparent);margin:10px 0}

/* Circle */
.circle-wrapper{display:flex;justify-content:center;align-items:center;margin:14px 0;position:relative}
svg{transform:rotate(-90deg)}
.circle-text{position:absolute;font-weight:800;letter-spacing:.3px}

/* Bars */
.bar{position:relative;height:18px;border-radius:999px;overflow:hidden;border:1px solid #223055;background:rgba(255,255,255,.06)}
.bar>.fill{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg,#60a5fa,#2563eb);box-shadow:0 0 12px rgba(37,99,235,.55) inset;transition:width .25s ease}
.bar .segline{position:absolute;top:2px;bottom:2px;width:2px;background:rgba(255,255,255,.12);border-radius:2px}

/* Fancy tiers */
.tier-basic{background:linear-gradient(90deg,#5ea2ff,#3b82f6)}
.tier-gold {background:linear-gradient(90deg,#ffe27a,#f59e0b);box-shadow:0 0 10px rgba(245,158,11,.45) inset}
.tier-diamond{background:linear-gradient(90deg,#a78bfa,#60a5fa);box-shadow:0 0 10px rgba(96,165,250,.45) inset}
.tier-myth{background:linear-gradient(90deg,#22d3ee,#a78bfa);box-shadow:0 0 10px rgba(34,211,238,.45) inset}

/* Topic list */
.topic{display:flex;gap:12px;align-items:center}
.topic-name{flex:0 0 240px;font-weight:700}

/* Image slot fits image size */
.tier-img-wrap{display:flex;align-items:center;justify-content:center;min-height:200px;border:1px dashed #2a375e;border-radius:16px;background:rgba(255,255,255,.03);overflow:hidden}
.tier-img{display:block;max-width:100%;height:auto}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(4,8,18,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.dialog{width:min(940px,100%);max-height:90vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.45)}
.dialog header, .dialog footer{padding:12px 14px;border-bottom:1px solid var(--border)}
.dialog footer{border-top:1px solid var(--border);border-bottom:0;display:flex;gap:10px;justify-content:flex-end}
.dialog .content{padding:14px}

/* Form */
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input[type="text"], input[type="number"], textarea{width:100%;padding:10px;border:1px solid #223055;border-radius:12px;background:#0e1526;color:var(--ink)}
textarea{min-height:68px;resize:vertical}

/* History */
table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{border-bottom:1px solid #203055;padding:10px 8px;text-align:left;font-size:13px;vertical-align:top}
th{color:var(--muted);font-weight:600}
.note-cell{white-space:pre-wrap;word-break:break-word}

/* Responsive */
@media (max-width:760px){
  .topic-name{flex:1 0 100%}
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Progressive Self-Development <span class="pill">v3 • Tiered</span></h1>
    <div class="wrap">
      <button class="btn" id="addTopicBtn">เพิ่มหัวข้อหลัก</button>
      <button class="btn secondary" id="exportAllBtn">ส่งออกข้อมูลทั้งหมด</button>
    </div>
  </header>

  <div class="circle-wrapper">
    <svg width="120" height="120">
      <circle cx="60" cy="60" r="50" stroke="#1f2b4a" stroke-width="12" fill="none"/>
      <circle id="progressCircle" cx="60" cy="60" r="50" stroke="#4f8cff" stroke-width="12" fill="none"
              stroke-linecap="round" stroke-dasharray="314.159" stroke-dashoffset="314.159"/>
    </svg>
    <div class="circle-text" id="circleText">0%</div>
  </div>

  <div class="card" id="radarCard">
    <div class="small">แตะหัวข้อหลักเพื่อเข้าไปดูหัวข้อย่อยและความคืบหน้าโดยรวม</div>
  </div>

  <section id="homeView" class="grid" style="margin-top:8px">
    <div id="topicsList" class="grid"></div>
  </section>

  <!-- ===== Main Topic ===== -->
  <section id="mainView" class="grid" style="display:none">
    <div class="card">
      <div class="row">
        <button class="btn ghost" id="backHomeBtn">← กลับหน้าแรก</button>
        <h2 id="mainTitle" style="margin:0"></h2>
        <span class="small right" id="mainSummary"></span>
        <button class="btn danger" id="deleteMainBtn">ลบหัวข้อหลักนี้</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <div style="font-weight:700">หัวข้อย่อย</div>
        <button class="btn secondary right" id="addSubBtn">เพิ่มหัวข้อย่อย (ตั้งค่า Tier)</button>
      </div>
      <div id="subsList" class="grid" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- ===== Sub Topic (Tiered) ===== -->
  <section id="subView" class="grid" style="display:none">
    <div class="card">
      <div class="row">
        <button class="btn ghost" id="backMainBtn">← กลับหัวข้อหลัก</button>
        <h2 id="subTitle" style="margin:0"></h2>
        <span class="small right" id="subLive"></span>
        <button class="btn secondary" id="editTierBtn">จัดการ Tier</button>
      </div>

      <div class="hr"></div>

      <div class="row" style="align-items:flex-start; gap:16px">
        <div class="card" style="flex:1;min-width:260px">
          <div class="small">Tier ปัจจุบัน</div>
          <div class="tier-img-wrap"><img id="currTierImg" class="tier-img" alt="current tier"/></div>
        </div>
        <div class="card" style="flex:2;min-width:280px">
          <div class="row"><div class="small">สถานะภาพรวมของหัวข้อย่อยนี้</div><span class="small right" id="subTierBadge"></span></div>
          <div class="bar" id="subAggregatedBar" style="margin-top:8px"><div class="fill"></div></div>
          <div class="small" id="subAggMeta" style="margin-top:6px"></div>
        </div>
        <div class="card" style="flex:1;min-width:260px">
          <div class="small">Tier ถัดไป</div>
          <div class="tier-img-wrap"><img id="nextTierImg" class="tier-img" alt="next tier"/></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <h3 style="margin:0">Quests</h3>
        <button class="btn secondary right" id="addQuestBtn">เพิ่ม Quest</button>
      </div>
      <div id="questsList" class="grid" style="margin-top:8px"></div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn success" id="saveSubBtn">Save (บันทึก)</button>
        <button class="btn ghost" id="discardSubBtn">ยกเลิกการแก้ไข</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <h3 style="margin:0">ประวัติ</h3>
        <button class="btn secondary right" id="exportCsvBtn">ส่งออก CSV</button>
      </div>
      <table id="historyTable">
        <colgroup><col style="width:170px"><col style="width:auto"><col style="width:110px"></colgroup>
        <thead><tr><th>วัน/เวลา</th><th>รายละเอียด</th><th>ชนิด</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card"><button class="btn danger" id="deleteSubBtn">ลบหัวข้อย่อยนี้</button></div>
  </section>
</div>

<!-- ===== Modal: สร้าง/แก้ Tier ของ Sub ===== -->
<div id="tierModal" class="modal">
  <div class="dialog">
    <header class="row">
      <div style="font-weight:700">ตั้งค่า Tier ของหัวข้อย่อย</div>
      <button class="btn ghost" id="closeTierModal">ปิด</button>
    </header>
    <div class="content">
      <div class="small" style="margin-bottom:6px">กำหนดชื่อ, จำนวนหน่วยต่อ tier, จำนวนช่อง (segments) และเลือกรูปได้</div>
      <div id="tierEditor"></div>
      <div class="hr"></div>
      <button class="btn secondary" id="addTierRow">+ เพิ่ม Tier</button>
    </div>
    <footer>
      <button class="btn ghost" id="cancelTierCfg">ยกเลิก</button>
      <button class="btn success" id="saveTierCfg">บันทึก Tier ของหัวข้อย่อย</button>
    </footer>
  </div>
</div>

<!-- ===== Modal: เพิ่ม/แก้ Quest ===== -->
<div id="questModal" class="modal">
  <div class="dialog">
    <header class="row">
      <div style="font-weight:700" id="qmTitle">ตั้งค่า Quest</div>
      <button class="btn ghost" id="closeQm">ปิด</button>
    </header>
    <div class="content">
      <div class="row">
        <div style="flex:2">
          <label>ชื่อ Quest</label>
          <input type="text" id="qmName" placeholder="เช่น Non-negotiable">
        </div>
      </div>
      <div class="hr"></div>
      <div class="small">Tier ของ Quest (กำหนดเงื่อนไข + หน่วย + segments ต่อ tier)</div>
      <div id="qmTierRows"></div>
      <button class="btn secondary" id="qmAddTier">+ เพิ่ม Tier</button>
    </div>
    <footer>
      <button class="btn ghost" id="qmCancel">ยกเลิก</button>
      <button class="btn success" id="qmSave">บันทึก Quest</button>
    </footer>
  </div>
</div>

<script defer>
/* ======================= Storage & Model (v3 tiered) ======================= */
const DB_KEY='psd_v3_tiered';
const OLD_KEY='psd_v2_nested';

function nowISO(){return new Date().toISOString();}
function uid(){return 'id'+Math.random().toString(36).slice(2,10);}
function loadRaw(k){ try{const r=localStorage.getItem(k); return r?JSON.parse(r):null;}catch(e){return null}}
function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
let db = loadRaw(DB_KEY);

/* --- migrate from v2 if needed (คงข้อมูลเดิมไว้ ไม่ลบทิ้ง) --- */
if(!db){
  const v2 = loadRaw(OLD_KEY);
  if(v2 && v2.topics){
    db = {version:3, topics:[]};
    v2.topics.forEach(t=>{
      const main={id:uid(), name:t.name||'Main', subs:[]};
      (t.subs||[]).forEach(s=>{
        const sub={
          id:uid(), name:s.name||'Sub',
          tierCfg:{tiers:[
            {name:'Beginner', units:5, segments:5, image:null},
            {name:'Intermediate', units:5, segments:6, image:null},
            {name:'Advanced', units:5, segments:7, image:null},
          ]},
          quests:[],
          history:(s.transactions||[]).map(r=>({time:r.time, detail:(r.note||'')+' ('+(r.delta>0?'+':'')+r.delta+' pts)', type:'LEGACY'}))
        };
        (s.quests||[]).forEach(q=>{
          sub.quests.push({
            id:uid(), title:q.title||'Quest', progress:{tier:0, unit:0},
            tiers:[
              {units:5, segments:5, condition:'', style:'basic'},
              {units:5, segments:6, condition:'', style:'gold'},
              {units:5, segments:7, condition:'', style:'diamond'},
            ]
          });
        });
        main.subs.push(sub);
      });
      db.topics.push(main);
    });
    saveDB(db); // keep old key as is
  }else{
    db = {version:3, topics:[]};
    saveDB(db);
  }
}

/* --- helpers --- */
function ensureMain(t){ t.subs ||= []; return t; }
function ensureSub(s){
  s.tierCfg ||= {tiers:[{name:'Beginner',units:5,segments:5,image:null},{name:'Intermediate',units:5,segments:6,image:null},{name:'Advanced',units:5,segments:7,image:null}]};
  s.quests ||= [];
  s.history ||= [];
  return s;
}
function ensureQuest(q){
  q.tiers ||= [{units:5,segments:5,condition:'',style:'basic'}];
  q.progress ||= {tier:0, unit:0};
  if(q.progress.tier>=q.tiers.length){ q.progress.tier=q.tiers.length-1; q.progress.unit=q.tiers[q.tiers.length-1].units }
  return q;
}

/* Quest overall percent across all tiers */
function questPercent(q){
  q=ensureQuest(q);
  const total = q.tiers.reduce((s,t)=>s+Number(t.units||1),0);
  let done = 0;
  for(let i=0;i<q.progress.tier;i++) done += Number(q.tiers[i].units||1);
  done += Math.min(q.progress.unit, Number(q.tiers[q.progress.tier].units||1));
  return total? (done/total)*100 : 0;
}

/* Sub percent = average of quest percents */
function subPercent(sub){
  sub=ensureSub(sub);
  if(!sub.quests.length) return 0;
  const sum=sub.quests.reduce((s,q)=>s+questPercent(q),0);
  return sum/sub.quests.length;
}

/* map sub percent to tier + inner progress */
function subTierView(sub){
  const tiers = sub.tierCfg.tiers||[];
  const p = subPercent(sub);
  if(!tiers.length) return {index:0, ratio:0, name:'', last:true};
  const step=100/tiers.length;
  let idx = Math.min(tiers.length-1, Math.floor(p/step));
  let inner = (p - idx*step) / step; if(idx===tiers.length-1) inner = 1; // full at last
  return {index:idx, ratio:inner, name:tiers[idx].name||('Tier '+(idx+1)), last: idx===tiers.length-1};
}

/* UI bits */
function format(n){return (Math.round(n*100)/100)}
function download(filename,text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1e3); }

/* ===== Circle (home avg) ===== */
function updateCircle(){
  const c=document.getElementById('progressCircle'), t=document.getElementById('circleText');
  if(!db.topics.length){ c.style.strokeDashoffset=314.159; t.textContent='0%'; return; }
  const mains = db.topics.map(ensureMain);
  const allSubs = mains.flatMap(m=>m.subs||[]);
  const avg = allSubs.length ? (allSubs.reduce((s,sub)=>s+subPercent(sub),0)/allSubs.length) : 0;
  const vis=Math.max(0,Math.min(100,avg));
  c.style.strokeDashoffset=314.159-(314.159*(vis/100));
  t.textContent=Math.round(vis)+'%';
}

/* ======================= Views ======================= */
const homeView=document.getElementById('homeView');
const mainView=document.getElementById('mainView');
const subView=document.getElementById('subView');
const topicsList=document.getElementById('topicsList');

const backHomeBtn=document.getElementById('backHomeBtn');
const mainTitle=document.getElementById('mainTitle');
const mainSummary=document.getElementById('mainSummary');
const subsList=document.getElementById('subsList');
const addSubBtn=document.getElementById('addSubBtn');
const deleteMainBtn=document.getElementById('deleteMainBtn');

const backMainBtn=document.getElementById('backMainBtn');
const subTitle=document.getElementById('subTitle');
const subLive=document.getElementById('subLive');
const currTierImg=document.getElementById('currTierImg');
const nextTierImg=document.getElementById('nextTierImg');
const subAggregatedBar=document.getElementById('subAggregatedBar');
const subAggFill=subAggregatedBar.querySelector('.fill');
const subAggMeta=document.getElementById('subAggMeta');
const subTierBadge=document.getElementById('subTierBadge');

const questsList=document.getElementById('questsList');
const saveSubBtn=document.getElementById('saveSubBtn');
const discardSubBtn=document.getElementById('discardSubBtn');
const deleteSubBtn=document.getElementById('deleteSubBtn');
const historyTableBody=document.querySelector('#historyTable tbody');
const exportCsvBtn=document.getElementById('exportCsvBtn');

const addTopicBtn=document.getElementById('addTopicBtn');
const exportAllBtn=document.getElementById('exportAllBtn');
const editTierBtn=document.getElementById('editTierBtn');

/* modals */
const tierModal=document.getElementById('tierModal');
const closeTierModal=document.getElementById('closeTierModal');
const tierEditor=document.getElementById('tierEditor');
const addTierRow=document.getElementById('addTierRow');
const saveTierCfg=document.getElementById('saveTierCfg');
const cancelTierCfg=document.getElementById('cancelTierCfg');

const questModal=document.getElementById('questModal');
const closeQm=document.getElementById('closeQm');
const qmTitle=document.getElementById('qmTitle');
const qmName=document.getElementById('qmName');
const qmTierRows=document.getElementById('qmTierRows');
const qmAddTier=document.getElementById('qmAddTier');
const qmSave=document.getElementById('qmSave');
const qmCancel=document.getElementById('qmCancel');

let currentMainId=null, currentSubId=null;
/* stage (clone) สำหรับหน้า sub – กดบันทึกค่อยเซฟจริง */
let stageSub=null;

/* ---------- Home ---------- */
function renderHome(){
  homeView.style.display='grid'; mainView.style.display='none'; subView.style.display='none';
  topicsList.innerHTML='';
  if(!db.topics.length){
    const card=document.createElement('div'); card.className='card small';
    card.textContent='ยังไม่มีหัวข้อหลัก กด “เพิ่มหัวข้อหลัก” ด้านบน';
    topicsList.appendChild(card);
  }else{
    db.topics.forEach(t=>{
      ensureMain(t);
      const subs=t.subs||[];
      const percent = subs.length? (subs.reduce((s,sub)=>s+subPercent(sub),0)/subs.length):0;
      const card=document.createElement('div'); card.className='card topic';
      card.innerHTML=
        `<div class="topic-name">${t.name}</div>
         <div class="bar" style="flex:1">
           <div class="fill" style="width:${percent}%"></div>
         </div>
         <div class="small" style="width:160px;text-align:right">${format(percent)}% • ${subs.length} ย่อย</div>
         <button class="btn ghost right del-main">ลบ</button>`;
      card.addEventListener('click',()=>openMain(t.id));
      card.querySelector('.del-main').addEventListener('click',e=>{
        e.stopPropagation();
        if(!confirm(`ลบ "${t.name}" พร้อมข้อมูลทั้งหมด?`)) return;
        db.topics=db.topics.filter(x=>x.id!==t.id); saveDB(db); renderHome(); updateCircle();
      });
      topicsList.appendChild(card);
    });
  }
  updateCircle();
}
addTopicBtn.addEventListener('click',()=>{
  const name=prompt('ชื่อหัวข้อหลัก'); if(!name) return;
  db.topics.push({id:uid(),name:name.trim(),subs:[]}); saveDB(db); renderHome();
});
exportAllBtn.addEventListener('click',()=>download('progress_backup_v3.json', JSON.stringify(db,null,2)));

/* ---------- Main ---------- */
function openMain(id){
  currentMainId=id; currentSubId=null;
  const main=db.topics.find(t=>t.id===id); ensureMain(main);
  homeView.style.display='none'; mainView.style.display='grid'; subView.style.display='none';
  mainTitle.textContent=main.name;
  const subs=main.subs||[];
  const percent=subs.length? (subs.reduce((s,sub)=>s+subPercent(sub),0)/subs.length):0;
  mainSummary.textContent=`ค่าเฉลี่ยย่อย: ${format(percent)}% • ${subs.length} ย่อย`;
  subsList.innerHTML='';
  if(!subs.length){
    const empty=document.createElement('div'); empty.className='card small'; empty.textContent='ยังไม่มีหัวข้อย่อย'; subsList.appendChild(empty);
  }else{
    subs.forEach(sub=>{
      ensureSub(sub);
      const p=subPercent(sub);
      const el=document.createElement('div'); el.className='card topic';
      el.innerHTML=`
        <div class="topic-name">${sub.name}</div>
        <div class="bar" style="flex:1"><div class="fill" style="width:${p}%"></div></div>
        <div class="small" style="width:120px;text-align:right">${format(p)}%</div>`;
      el.addEventListener('click',()=>openSub(sub.id));
      subsList.appendChild(el);
    });
  }
}
backHomeBtn.addEventListener('click',()=>{ currentMainId=null; renderHome(); });
addSubBtn.addEventListener('click',()=>{ // open wizard
  const main=db.topics.find(t=>t.id===currentMainId); if(!main) return;
  const name=prompt('ชื่อหัวข้อย่อย'); if(!name) return;
  const sub={id:uid(),name:name.trim(),tierCfg:{tiers:[
    {name:'Beginner',units:5,segments:5,image:null},
    {name:'Intermediate',units:5,segments:6,image:null},
    {name:'Advanced',units:5,segments:7,image:null},
  ]},quests:[],history:[]};
  main.subs.push(sub); saveDB(db);
  currentSubId=sub.id; openSub(sub.id); // และเปิด editor tier
  openTierEditor(sub);
});
deleteMainBtn.addEventListener('click',()=>{
  if(!currentMainId) return;
  const i=db.topics.findIndex(t=>t.id===currentMainId); if(i<0) return;
  if(!confirm(`ลบ "${db.topics[i].name}" พร้อมข้อมูลทั้งหมด?`)) return;
  db.topics.splice(i,1); saveDB(db); currentMainId=null; renderHome();
});

/* ---------- Sub ---------- */
function openSub(subId){
  currentSubId=subId;
  const main=db.topics.find(t=>t.id===currentMainId);
  const sub=ensureSub(main.subs.find(s=>s.id===subId));
  // clone to stage
  stageSub=JSON.parse(JSON.stringify(sub));

  mainView.style.display='none'; homeView.style.display='none'; subView.style.display='grid';
  subTitle.textContent=`${main.name} › ${sub.name}`;
  renderSubStage();
}
backMainBtn.addEventListener('click',()=>openMain(currentMainId));

function renderSubStage(){
  const main=db.topics.find(t=>t.id===currentMainId);
  const sub=stageSub; ensureSub(sub);

  const view = subTierView(sub);
  const tiers=sub.tierCfg.tiers;
  const curr = tiers[view.index]||{};
  const next = tiers[view.index+1];

  // images
  currTierImg.src = curr.image || '';
  currTierImg.style.display = curr.image? 'block':'none';
  nextTierImg.src = view.last ? (curr.image||'') : (next?.image||'');
  nextTierImg.style.display = view.last ? (curr.image? 'block':'none') : (next?.image? 'block':'none');

  if(view.last){
    nextTierImg.parentElement.style.justifyContent='center';
  }else{
    nextTierImg.parentElement.style.justifyContent='center';
  }

  // agg bar
  const p = subPercent(sub);
  subAggFill.style.width = p+'%';
  subAggFill.className='fill '+tierFillClass(view.index);
  buildSegments(subAggregatedBar, (tiers[view.index]?.segments||5)* (view.last?1:1));
  subAggMeta.textContent = `ความคืบหน้าเฉลี่ยจาก Quest: ${format(p)}%`;
  subTierBadge.textContent = `Tier ${view.index+1}/${tiers.length} • ${curr.name||('Tier '+(view.index+1))}`;
  subLive.textContent = `ค่า ณ ปัจจุบัน: ${format(p)}%`;

  // quests
  renderQuestsEditor(sub);
  // history
  renderHistory(sub);
}

function tierFillClass(idx){
  if(idx>=3) return 'tier-myth';
  if(idx===2) return 'tier-diamond';
  if(idx===1) return 'tier-gold';
  return 'tier-basic';
}
function buildSegments(barEl, segments){
  [...barEl.querySelectorAll('.segline')].forEach(e=>e.remove());
  segments = Math.max(0, Number(segments||0));
  for(let i=1;i<segments;i++){
    const d=document.createElement('div'); d.className='segline';
    d.style.left = (i*100/segments)+'%'; barEl.appendChild(d);
  }
}

/* quests list */
function renderQuestsEditor(sub){
  questsList.innerHTML='';
  if(!sub.quests.length){
    const empty=document.createElement('div'); empty.className='small card'; empty.textContent='ยังไม่มี Quest'; questsList.appendChild(empty);
  }
  sub.quests.forEach(q=>{
    ensureQuest(q);
    const t=q.tiers[q.progress.tier]||{units:1,segments:0};
    const percent = questPercent(q);
    const row=document.createElement('div'); row.className='card';
    row.innerHTML=`
      <div class="row" style="align-items:flex-start">
        <div style="flex:1">
          <div style="font-weight:700">${q.title} <span class="pill">T${q.progress.tier+1}/${q.tiers.length}</span></div>
          <div class="small" style="margin-top:4px;color:#ffd483">${(t.condition||'')}</div>
        </div>
        <div class="bar" style="flex:2; min-width:220px">
          <div class="fill ${tierFillClass(q.progress.tier)}" style="width:${percent}%"></div>
        </div>
        <div class="wrap right">
          <button class="btn success qPlus">เพิ่ม +</button>
          <button class="btn danger qMinus">ลด −</button>
          <button class="btn secondary qEdit">แก้ไข</button>
          <button class="btn ghost qDel">ลบ</button>
        </div>
      </div>`;
    buildSegments(row.querySelector('.bar'), t.segments||0);

    row.querySelector('.qPlus').onclick=()=>{ incQuest(q,+1); renderSubStage(); };
    row.querySelector('.qMinus').onclick=()=>{ incQuest(q,-1); renderSubStage(); };
    row.querySelector('.qEdit').onclick=()=>openQuestEditor(q);
    row.querySelector('.qDel').onclick=()=>{ if(confirm('ลบ Quest นี้?')){ sub.quests=sub.quests.filter(x=>x.id!==q.id); renderSubStage(); } };
    questsList.appendChild(row);
  });
}

/* plus/minus quest logic + history (stage only) */
function incQuest(q,delta){
  const t=q.tiers[q.progress.tier];
  if(delta>0){
    q.progress.unit += 1;
    if(q.progress.unit>=t.units){
      if(q.progress.tier<q.tiers.length-1){
        q.progress.tier+=1; q.progress.unit=0;
        stageSub.history.push({time:nowISO(), detail:`${q.title} → T${q.progress.tier+1}`, type:'QUEST_TIER_UP'});
      }else{
        q.progress.unit=t.units; // max
      }
    }
  }else{
    q.progress.unit -= 1;
    if(q.progress.unit<0){
      if(q.progress.tier>0){
        q.progress.tier-=1;
        q.progress.unit = (q.tiers[q.progress.tier].units||1)-1;
        stageSub.history.push({time:nowISO(), detail:`${q.title} → T${q.progress.tier+1}`, type:'QUEST_TIER_DOWN'});
      }else{
        q.progress.unit=0;
      }
    }
  }
}

/* save/discard for sub */
saveSubBtn.addEventListener('click',()=>{
  const main=db.topics.find(t=>t.id===currentMainId);
  const i=main.subs.findIndex(s=>s.id===currentSubId);
  main.subs[i]=JSON.parse(JSON.stringify(stageSub));
  saveDB(db);
  alert('บันทึกแล้ว');
  openMain(currentMainId);
});
discardSubBtn.addEventListener('click',()=>{ openSub(currentSubId); });
deleteSubBtn.addEventListener('click',()=>{
  if(!confirm('ลบหัวข้อย่อยนี้และข้อมูลทั้งหมด?')) return;
  const main=db.topics.find(t=>t.id===currentMainId);
  main.subs=main.subs.filter(s=>s.id!==currentSubId); saveDB(db); openMain(currentMainId);
});
exportCsvBtn.addEventListener('click',()=>{
  const main=db.topics.find(t=>t.id===currentMainId);
  const sub=main.subs.find(s=>s.id===currentSubId);
  const rows=[['time','detail','type']].concat((sub.history||[]).map(r=>[r.time,r.detail||'',r.type||'']));
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  download(`${main.name.replace(/\s+/g,'_')}__${sub.name.replace(/\s+/g,'_')}_history.csv`, csv);
});
function renderHistory(sub){
  historyTableBody.innerHTML='';
  (sub.history||[]).slice().reverse().forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date(r.time).toLocaleString()}</td><td class="note-cell">${r.detail||''}</td><td>${r.type||''}</td>`;
    historyTableBody.appendChild(tr);
  });
}

/* ---------- Tier editor (sub) ---------- */
editTierBtn.addEventListener('click',()=>{
  const main=db.topics.find(t=>t.id===currentMainId);
  const sub=stageSub; openTierEditor(sub);
});
function openTierEditor(sub){
  tierEditor.innerHTML='';
  (sub.tierCfg.tiers||[]).forEach((tier,idx)=> tierEditor.appendChild(buildTierRow(tier, idx)));
  tierModal.style.display='flex';
}
function fileToDataURL(file,cb){
  const r=new FileReader(); r.onload=()=>cb(String(r.result)); r.readAsDataURL(file);
}
function buildTierRow(tier, idx){
  const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`
    <div class="row" style="align-items:flex-end">
      <div style="flex:1">
        <label>ชื่อ Tier</label>
        <input type="text" value="${tier.name||''}" class="tName">
      </div>
      <div style="width:120px">
        <label>หน่วย</label>
        <input type="number" min="1" step="1" value="${tier.units||1}" class="tUnits">
      </div>
      <div style="width:130px">
        <label>segments</label>
        <input type="number" min="0" step="1" value="${tier.segments||0}" class="tSeg">
      </div>
      <div class="right">
        <label>เลือกรูป</label>
        <input type="file" class="tFile" accept="image/*">
      </div>
      <button class="btn ghost tDel">ลบ</button>
    </div>
    <div class="tier-img-wrap" style="margin-top:8px"><img class="tier-img tPreview" ${tier.image?`src="${tier.image}"`:''}></div>
  `;
  const file=wrap.querySelector('.tFile');
  const preview=wrap.querySelector('.tPreview');
  file.onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return; fileToDataURL(f,(url)=>{ preview.src=url; preview.style.display='block'; preview.dataset.new='1'; }); };
  wrap.querySelector('.tDel').onclick=()=>{ wrap.remove(); };
  return wrap;
}
addTierRow.addEventListener('click',()=>tierEditor.appendChild(buildTierRow({name:'New',units:5,segments:5,image:null},0)));
cancelTierCfg.addEventListener('click',()=>tierModal.style.display='none');
closeTierModal.addEventListener('click',()=>tierModal.style.display='none');
saveTierCfg.addEventListener('click',()=>{
  // collect
  const rows=[...tierEditor.children];
  const tiers = rows.map(row=>({
    name: row.querySelector('.tName').value.trim()||'Tier',
    units: Math.max(1, Number(row.querySelector('.tUnits').value||1)),
    segments: Math.max(0, Number(row.querySelector('.tSeg').value||0)),
    image: row.querySelector('.tPreview').getAttribute('src')||null,
  })).filter(Boolean);
  if(!tiers.length) return alert('ต้องมีอย่างน้อย 1 tier');
  stageSub.tierCfg.tiers = tiers;
  // ถ้า tier ปัจจุบันเกินขนาดใหม่ → clamp
  (stageSub.quests||[]).forEach(q=>{
    if(q.progress.tier>=q.tiers.length) q.progress.tier=q.tiers.length-1;
  });
  tierModal.style.display='none';
  renderSubStage();
});

/* ---------- Quest editor ---------- */
let editingQuest=null;
document.getElementById('addQuestBtn').addEventListener('click',()=>openQuestEditor());
function qmTierRow(tier, idx){
  const row=document.createElement('div'); row.className='card';
  row.innerHTML=`
    <div class="row">
      <div style="width:120px">
        <label>หน่วย</label><input type="number" class="qUnits" value="${tier.units||5}" min="1" step="1">
      </div>
      <div style="width:120px">
        <label>segments</label><input type="number" class="qSeg" value="${tier.segments||5}" min="0" step="1">
      </div>
      <div style="flex:2">
        <label>เงื่อนไข (จะแสดงใต้ชื่อ)</label><input type="text" class="qCond" value="${tier.condition||''}" placeholder="เช่น ทำครบชุดรายวัน">
      </div>
      <div style="width:160px">
        <label>สไตล์หลอด</label>
        <select class="qStyle">
          <option value="basic" ${tier.style==='basic'?'selected':''}>Basic (ฟ้า)</option>
          <option value="gold" ${tier.style==='gold'?'selected':''}>Gold</option>
          <option value="diamond" ${tier.style==='diamond'?'selected':''}>Diamond</option>
          <option value="myth" ${tier.style==='myth'?'selected':''}>Mythic</option>
        </select>
      </div>
      <button class="btn ghost qDelTier">ลบ</button>
    </div>`;
  row.querySelector('.qDelTier').onclick=()=>row.remove();
  return row;
}
function openQuestEditor(q){
  editingQuest = q? q : {id:uid(), title:'', progress:{tier:0,unit:0}, tiers:[{units:5,segments:5,condition:'',style:'basic'}]};
  qmName.value = editingQuest.title||'';
  qmTierRows.innerHTML='';
  (editingQuest.tiers||[]).forEach((t,i)=> qmTierRows.appendChild(qmTierRow(t,i)) );
  questModal.style.display='flex';
  qmTitle.textContent = q?'แก้ไข Quest':'เพิ่ม Quest';
}
qmAddTier.addEventListener('click',()=> qmTierRows.appendChild(qmTierRow({units:5,segments:5,condition:'',style:'gold'},0)) );
qmCancel.addEventListener('click',()=> questModal.style.display='none');
closeQm.addEventListener('click',()=> questModal.style.display='none');
qmSave.addEventListener('click',()=>{
  const name=qmName.value.trim(); if(!name) return alert('กรุณาตั้งชื่อ Quest');
  const tiers=[...qmTierRows.children].map(r=>({
    units: Math.max(1, Number(r.querySelector('.qUnits').value||1)),
    segments: Math.max(0, Number(r.querySelector('.qSeg').value||0)),
    condition: r.querySelector('.qCond').value||'',
    style: r.querySelector('.qStyle').value||'basic'
  }));
  if(!tiers.length) return alert('ต้องมีอย่างน้อย 1 tier');
  editingQuest.title=name; editingQuest.tiers=tiers;
  if(editingQuest.progress.tier>=tiers.length) editingQuest.progress.tier=tiers.length-1;
  // put to stage
  const sub=stageSub;
  const ex=sub.quests.find(x=>x.id===editingQuest.id);
  if(ex){ Object.assign(ex, editingQuest); }
  else sub.quests.push(editingQuest);
  questModal.style.display='none';
  renderSubStage();
});

/* ======================= Init ======================= */
function start(){
  db.topics.forEach(ensureMain);
  renderHome();
}
window.addEventListener('DOMContentLoaded', start);
</script>
</body>
</html>
