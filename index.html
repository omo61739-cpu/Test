<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Progressive Self-Development • Tier (iPad-Safe)</title>
<style>
  :root{
    --bg:#f7f9ff;--card:#ffffff;--ink:#0f1220;--muted:#6b7280;
    --accent:#2563eb;--accent-2:#10b981;--danger:#ef4444;--border:#e5e7eb;
    --ring:0 12px 36px rgba(15,18,32,.06);--gold:#d4af37;--gold-2:#ffe08a;--dia:#55d0ff;--dia-2:#a0f0ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#f7f9ff,#eef2ff);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:1040px;margin:0 auto;padding:18px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
  h1{font-size:22px;margin:0}
  .btn{border:0;border-radius:12px;padding:10px 14px;font-size:14px;cursor:pointer;background:var(--accent);color:#fff;transition:.18s;box-shadow:0 1px 1px rgba(0,0,0,.04)}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(37,99,235,.25)}
  .btn.secondary{background:#e5e7eb;color:#111}.btn.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
  .btn.success{background:var(--accent-2)}.btn.danger{background:var(--danger)}
  .grid{display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--ring)}
  .small{font-size:12px;color:var(--muted)} .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#f9fafb}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#fff;margin-left:6px}
  .right{margin-left:auto}
  #radarCard canvas,#topicRadarCard canvas{display:block;width:100%;max-width:720px;margin:auto;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--ring)}

  .topic{display:flex;gap:12px;align-items:center}
  .topic-name{flex:0 0 260px;font-weight:700}
  .listbar{position:relative;flex:1;height:12px;background:#eef3fb;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .listbar>span{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,#9cc1ff,#2563eb);transition:width .4s}

  /* Tier header */
  .tier-head{display:grid;grid-template-columns:1fr 1.3fr 1fr;gap:16px;align-items:center}
  .tier-head.centered{grid-template-columns:1fr 1fr}
  .tier-col.center{grid-column:1 / span 2;text-align:center}
  .tier-img{display:inline-block;border:1px solid var(--border);border-radius:16px;background:#fff;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)}
  .tier-img img{display:block;max-width:100%;height:auto}

  .seg-label{display:flex;justify-content:space-between;align-items:center}
  .segbar{display:flex;gap:8px;align-items:center}
  .segbar .seg{flex:1;height:14px;border-radius:999px;position:relative;overflow:hidden;border:1px solid #dce3f2;background:linear-gradient(180deg,#eef2f7,#e8edf6);box-shadow:inset 0 1px 2px rgba(0,0,0,.06)}
  .segbar .fill{position:absolute;inset:0;right:auto;width:0;transition:width .45s cubic-bezier(.2,.8,.2,1);background:linear-gradient(90deg,#7bb0ff,#3b82f6)}
  .segbar .gloss{position:absolute;left:0;right:0;bottom:0;height:40%;background:linear-gradient(180deg,rgba(255,255,255,.7),rgba(255,255,255,0))}
  .segbar.gold .seg{border-color:#f1e2a8;background:linear-gradient(180deg,#fff7d5,#fdecb3)}
  .segbar.gold .fill{background:linear-gradient(90deg,var(--gold-2),var(--gold))}
  .segbar.dia .seg{border-color:#cbefff;background:linear-gradient(180deg,#eefcff,#dff6ff)}
  .segbar.dia .fill{background:linear-gradient(90deg,var(--dia-2),var(--dia))}

  .quest-row{display:grid;grid-template-columns:1fr 360px 230px;gap:14px;align-items:center}
  .quest-card{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff}
  @media (max-width:900px){ .quest-row{grid-template-columns:1fr} }

  /* Modal */
  .modal{position:fixed;inset:0;pointer-events:none;background:rgba(15,18,32,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:50}
  .modal.show{display:flex;pointer-events:auto}
  .dialog{width:min(980px,calc(100% - 24px));max-height:90vh;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:0 26px 70px rgba(0,0,0,.18)}
  .dialog header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
  .dialog .content{padding:16px}
  .dialog footer{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border);background:#fafafa}
  .tier-row{display:grid;grid-template-columns:140px 1fr 140px 230px;gap:12px;align-items:center;margin-bottom:10px}
  .img-thumb{width:100%;height:auto;max-height:92px;object-fit:cover;border:1px solid var(--border);border-radius:12px;background:#f2f2f2}

  /* Error banner */
  #errbar{position:fixed;left:12px;right:12px;bottom:12px;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;padding:10px 12px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08);display:none;z-index:100}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Progressive Self-Development</h1>
    <div class="row">
      <button class="btn" id="addTopicBtn">เพิ่มหัวข้อหลัก</button>
      <button class="btn secondary" id="exportAllBtn">ส่งออกข้อมูลทั้งหมด</button>
      <span class="pill">v3.2c • Local (iPad-Safe)</span>
    </div>
  </header>

  <div class="card" id="radarCard" style="overflow:hidden">
    <div class="small" style="margin-bottom:6px">สรุปภาพรวมหน้าแรก</div>
    <canvas id="radarCanvas" height="140"></canvas>
  </div>

  <section id="homeView" class="grid">
    <div class="card"><div class="small">แตะหัวข้อหลักเพื่อจัดการหัวข้อย่อย</div></div>
    <div id="topicsList" class="grid"></div>
  </section>

  <section id="mainView" class="grid" style="display:none">
    <div class="card">
      <div class="row">
        <button class="btn ghost" id="backHomeBtn">← กลับหน้าแรก</button>
        <h2 id="mainTitle" style="margin:0"></h2>
        <span class="right small" id="mainSummary"></span>
        <button class="btn secondary" id="addSubBtn">เพิ่มหัวข้อย่อย</button>
        <button class="btn danger" id="deleteMainBtn">ลบหัวข้อหลักนี้</button>
      </div>
    </div>
    <div class="card" id="topicRadarCard" style="overflow:hidden">
      <div class="small" style="margin-bottom:6px">เรดาร์หัวข้อย่อยของหัวข้อหลักนี้</div>
      <canvas id="topicRadarCanvas" height="200"></canvas>
    </div>
    <div class="card">
      <div class="row"><div style="font-weight:700">หัวข้อย่อย</div></div>
      <div id="subsList" class="grid" style="margin-top:8px"></div>
    </div>
  </section>

  <section id="subView" class="grid" style="display:none">
    <div class="card">
      <div class="row">
        <button class="btn ghost" id="backMainBtn">← กลับหัวข้อหลัก</button>
        <h2 id="subTitle" style="margin:0"></h2>
        <span class="right small" id="subLive"></span>
      </div>
      <div class="tier-head" id="tierHead">
        <div class="tier-col" id="tierLeftCol">
          <div class="small">Tier ปัจจุบัน</div>
          <div class="tier-img"><img id="tierLeftImg" alt=""></div>
        </div>
        <div id="tierMetaCol">
          <div class="row"><div class="small">ภาพรวมของหัวข้อย่อยนี้</div><div class="right pill" id="tierBadge">Tier 1 / 1</div></div>
          <div class="seg-label small"><span>ความคืบหน้าเฉลี่ยจากทุก Quest</span><span id="tierPercent">0%</span></div>
          <div id="subSegbar" class="segbar"></div>
          <div class="small">* หลอดรวมเต็มแล้วจะเลื่อนไป Tier ถัดไป</div>
        </div>
        <div class="tier-col" id="tierRightCol">
          <div class="small" id="tierRightTitle">Tier ถัดไป</div>
          <div class="tier-img"><img id="tierRightImg" alt=""></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <h3 style="margin:0">Quests</h3>
        <button class="btn secondary right" id="addQuestBtn">เพิ่ม Quest</button>
      </div>
      <div id="questsList" class="grid" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <h3 style="margin:0">ประวัติ</h3>
        <button class="btn secondary right" id="exportCsvBtn">ส่งออก CSV</button>
      </div>
      <table id="historyTable" style="width:100%;border-collapse:collapse">
        <colgroup><col style="width:180px"><col><col style="width:120px"></colgroup>
        <thead><tr><th class="small">วัน/เวลา</th><th class="small">รายละเอียด</th><th class="small">ชนิด</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card"><button class="btn danger" id="deleteSubBtn">ลบหัวข้อย่อยนี้</button></div>
  </section>
</div>

<!-- Sub setup -->
<div id="subSetupModal" class="modal">
  <div class="dialog">
    <header><div style="font-weight:700">ตั้งค่า Tier สำหรับหัวข้อย่อยใหม่</div><button class="btn ghost" id="ssClose">ปิด</button></header>
    <div class="content">
      <div class="row">
        <div style="flex:1"><div class="small">ชื่อหัวข้อย่อย</div><input id="ssName" type="text" placeholder="เช่น Self-Discipline"></div>
        <div style="width:160px"><div class="small">จำนวน Tier</div><input id="ssCount" type="number" min="1" step="1" value="3"></div>
      </div>
      <div class="small" style="margin-top:8px">กำหนดรูป/ชื่อ/จำนวนหลอดของแต่ละ Tier</div>
      <div id="ssRows"></div>
    </div>
    <footer><button class="btn ghost" id="ssCancel">ยกเลิก</button><button class="btn success" id="ssCreate">สร้างหัวข้อย่อย</button></footer>
  </div>
</div>

<!-- Quest setup -->
<div id="questSetupModal" class="modal">
  <div class="dialog">
    <header><div style="font-weight:700">ตั้งค่า Tier ของ Quest</div><button class="btn ghost" id="qsClose">ปิด</button></header>
    <div class="content">
      <div class="row">
        <div style="flex:1"><div class="small">ชื่อ Quest</div><input id="qsName" type="text" placeholder="เช่น Non-negotiable"></div>
        <div style="width:160px"><div class="small">จำนวน Tier</div><input id="qsCount" type="number" min="1" step="1" value="3"></div>
      </div>
      <div class="small" style="margin-top:8px">กำหนดชื่อ/จำนวนหลอด/เงื่อนไขของแต่ละ Tier</div>
      <div id="qsRows"></div>
    </div>
    <footer><button class="btn ghost" id="qsCancel">ยกเลิก</button><button class="btn success" id="qsCreate">บันทึก Quest</button></footer>
  </div>
</div>

<div id="errbar"></div>

<script>
/* ===== Fatal error banner ===== */
window.onerror=function(msg,src,lin,col,err){
  var el=document.getElementById('errbar');
  el.textContent='เกิดข้อผิดพลาดในสคริปต์: '+msg+' @'+lin+':'+col;
  el.style.display='block';
};

/* ===== Helpers (no modern syntax) ===== */
function toggleClass(el, cls, force){
  if(!el) return;
  if(force===true){ if(el.className.indexOf(cls)<0) el.className+=' '+cls; return; }
  if(force===false){ el.className=el.className.replace(new RegExp('\\b'+cls+'\\b','g'),'').replace(/\s\s+/g,' ').trim(); return; }
  if(el.className.indexOf(cls)>=0){ el.className=el.className.replace(new RegExp('\\b'+cls+'\\b','g'),'').replace(/\s\s+/g,' ').trim(); }
  else{ el.className+=' '+cls; }
}
function byId(id){return document.getElementById(id);}

/* ===== Storage ===== */
var DB_KEY='psd_v32c_tier';
function nowISO(){return new Date().toISOString();}
function uid(){return 'id'+Math.random().toString(36).slice(2,10);}
function loadDB(){try{var raw=localStorage.getItem(DB_KEY);return raw?JSON.parse(raw):{version:'3.2c',topics:[]};}catch(e){return {version:'3.2c',topics:[]};}}
function saveDB(s){localStorage.setItem(DB_KEY, JSON.stringify(s));}
var db=loadDB();

/* ===== Model guards ===== */
function ensureMain(t){ if(!t.subs) t.subs=[]; return t; }
function ensureSub(s){
  if(!s.tierConfig) s.tierConfig={tiers:[{name:'Tier 1',units:5,img:''}]};
  s.tierIndex = Math.max(0, Number(s.tierIndex||0));
  if(!s.quests) s.quests=[];
  if(!s.logs) s.logs=[];
  return s;
}
function ensureQuest(q){
  if(!q.tierConfig) q.tierConfig={tiers:[{name:'T1',units:5,cond:''}]};
  q.tierConfig.tiers=(q.tierConfig.tiers||[]).map(function(t){return {name:t.name||'T',units:t.units||5,cond:t.cond||''};});
  q.tierIndex=Math.max(0,Number(q.tierIndex||0));
  q.progress=Math.max(0,Number(q.progress||0));
  return q;
}
function topicProgressPercent(t){
  if(!t.subs||!t.subs.length) return 0;
  var sum=0; for(var i=0;i<t.subs.length;i++){ var s=ensureSub(t.subs[i]); sum+=((s.tierIndex+1)/s.tierConfig.tiers.length)*100; }
  return Math.round(sum/t.subs.length);
}
function tierStyleByIndex(idx){ if(idx>=2) return 'dia'; if(idx===1) return 'gold'; return ''; }

/* ===== Seg bar ===== */
function buildSegBar(container, segments, filledUnits, styleCls){
  container.className='segbar '+(styleCls||''); container.innerHTML='';
  var full=Math.floor(filledUnits), frac=Math.max(0,Math.min(1, filledUnits-full));
  for(var i=0;i<segments;i++){
    var seg=document.createElement('div'); seg.className='seg';
    var fill=document.createElement('div'); fill.className='fill';
    var gloss=document.createElement('div'); gloss.className='gloss';
    if(i<full) fill.style.width='100%';
    else if(i===full) fill.style.width=(frac*100)+'%';
    seg.appendChild(fill); seg.appendChild(gloss);
    container.appendChild(seg);
  }
}

/* ===== Radar ===== */
function drawRadarOn(canvasId, labels, percents, subtitle){
  var cvs=document.getElementById(canvasId); if(!cvs) return;
  var ctx=cvs.getContext('2d');
  var cssW=(cvs.offsetWidth||cvs.clientWidth||700);
  var cssH=labels.length?300:140;
  var DPR=Math.max(1,window.devicePixelRatio||1);
  cvs.width=cssW*DPR; cvs.height=cssH*DPR; cvs.style.height=cssH+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0); ctx.clearRect(0,0,cssW,cssH);
  if(!labels.length){ ctx.fillStyle='#6b7280'; ctx.font='16px system-ui'; ctx.textAlign='center'; ctx.fillText('ยังไม่มีหัวข้อหลัก', cssW/2, cssH/2); return; }
  var N=labels.length, vals=percents.map(function(v){return Math.max(0,Math.min(100,v));}), cx=cssW/2, cy=cssH/2+6, maxR=Math.min(cssW,cssH)*0.36, steps=5;
  ctx.lineWidth=1;
  for(var s=1;s<=steps;s++){ var r=(s/steps)*maxR; ctx.beginPath(); for(var i=0;i<N;i++){ var a=(i/N)*Math.PI*2-Math.PI/2; var x=cx+r*Math.cos(a),y=cy+r*Math.sin(a); if(i)ctx.lineTo(x,y); else ctx.moveTo(x,y);} ctx.closePath(); ctx.strokeStyle='#e5e7eb'; ctx.stroke(); }
  ctx.font='12px system-ui'; ctx.fillStyle='#0f1220'; ctx.textAlign='center'; ctx.textBaseline='middle';
  for(i=0;i<N;i++){ var a2=(i/N)*Math.PI*2-Math.PI/2; var x2=cx+maxR*Math.cos(a2), y2=cy+maxR*Math.sin(a2); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x2,y2); ctx.strokeStyle='#e5e7eb'; ctx.stroke(); var lx=cx+(maxR+16)*Math.cos(a2), ly=cy+(maxR+16)*Math.sin(a2); ctx.fillText(labels[i], lx, ly); }
  var pts=vals.map(function(v,i){ var a=(i/N)*Math.PI*2-Math.PI/2, r=(v/100)*maxR; return {x:cx+r*Math.cos(a),y:cy+r*Math.sin(a)};});
  ctx.beginPath(); for(i=0;i<N;i++){ var p=pts[i]; if(i)ctx.lineTo(p.x,p.y); else ctx.moveTo(p.x,p.y);} ctx.closePath();
  ctx.fillStyle='rgba(37,99,235,.18)'; ctx.strokeStyle='#2563eb'; ctx.lineWidth=2; ctx.fill(); ctx.stroke();
  ctx.fillStyle='#2563eb'; for(i=0;i<N;i++){ var pt=pts[i]; ctx.beginPath(); ctx.arc(pt.x,pt.y,3,0,Math.PI*2); ctx.fill(); }
}

/* ===== DOM refs ===== */
var homeView=byId('homeView'), mainView=byId('mainView'), subView=byId('subView');
var topicsList=byId('topicsList'), subsList=byId('subsList');
var backHomeBtn=byId('backHomeBtn'), backMainBtn=byId('backMainBtn');
var mainTitle=byId('mainTitle'), mainSummary=byId('mainSummary');
var deleteMainBtn=byId('deleteMainBtn'), deleteSubBtn=byId('deleteSubBtn');
var subTitle=byId('subTitle'), subLive=byId('subLive');
var tierHead=byId('tierHead'), tierLeftCol=byId('tierLeftCol'), tierRightCol=byId('tierRightCol');
var tierLeftImg=byId('tierLeftImg'), tierRightImg=byId('tierRightImg');
var tierRightTitle=byId('tierRightTitle'), tierBadge=byId('tierBadge'), tierPercent=byId('tierPercent');
var subSegbar=byId('subSegbar');
var historyTableBody=document.querySelector('#historyTable tbody');
var exportCsvBtn=byId('exportCsvBtn');
var addSubBtn=byId('addSubBtn'), addQuestBtn=byId('addQuestBtn');

/* ===== Modals ===== */
var subSetupModal=byId('subSetupModal'), ssName=byId('ssName'), ssCount=byId('ssCount'), ssRows=byId('ssRows');
byId('ssClose').onclick=function(){ subSetupModal.className='modal'; };
byId('ssCancel').onclick=function(){ subSetupModal.className='modal'; };
byId('ssCreate').onclick=createSubFromSetup;

var questSetupModal=byId('questSetupModal'), qsName=byId('qsName'), qsCount=byId('qsCount'), qsRows=byId('qsRows');
byId('qsClose').onclick=function(){ questSetupModal.className='modal'; questSetupModal.removeAttribute('data-edit-id'); };
byId('qsCancel').onclick=function(){ questSetupModal.className='modal'; questSetupModal.removeAttribute('data-edit-id'); };
byId('qsCreate').onclick=createQuestFromSetup;

var currentMainId=null, currentSubId=null;

/* ===== Views ===== */
function renderHome(){
  homeView.style.display='grid'; mainView.style.display='none'; subView.style.display='none';
  topicsList.innerHTML='';
  if(!db.topics.length){ var card=document.createElement('div'); card.className='card'; card.innerHTML='<div class="small">ยังไม่มีหัวข้อหลัก</div>'; topicsList.appendChild(card); }
  for(var i=0;i<db.topics.length;i++){
    var t=ensureMain(db.topics[i]); var p=topicProgressPercent(t);
    var card=document.createElement('div'); card.className='card topic';
    card.innerHTML='<div class="topic-name">'+(t.name||'หัวข้อหลัก')+'</div><div class="listbar"><span style="width:'+p+'%"></span></div><div class="small" style="width:160px;text-align:right">'+p+'% • '+t.subs.length+' ย่อย</div>';
    card.onclick=(function(id){ return function(){ openMain(id); }; })(t.id);
    topicsList.appendChild(card);
  }
  drawRadarOn('radarCanvas', db.topics.map(function(t){return t.name||'';}), db.topics.map(topicProgressPercent), 'ภาพรวมแบบง่าย');
}

function openMain(id){
  currentMainId=id; currentSubId=null;
  var main=null; for(var i=0;i<db.topics.length;i++){ if(db.topics[i].id===id){ main=db.topics[i]; break; } }
  ensureMain(main);
  homeView.style.display='none'; mainView.style.display='grid'; subView.style.display='none';
  mainTitle.textContent=main.name||'หัวข้อหลัก';
  mainSummary.textContent='หัวข้อย่อยทั้งหมด: '+main.subs.length;
  subsList.innerHTML='';
  if(!main.subs.length){ var empty=document.createElement('div'); empty.className='small'; empty.textContent='ยังไม่มีหัวข้อย่อย'; subsList.appendChild(empty); }
  for(i=0;i<main.subs.length;i++){
    var sub=ensureSub(main.subs[i]); var total=sub.tierConfig.tiers.length; var p=Math.round(((sub.tierIndex+1)/total)*100);
    var tierNow=sub.tierConfig.tiers[sub.tierIndex]||{name:'—'};
    var el=document.createElement('div'); el.className='card topic';
    el.innerHTML='<div class="topic-name">'+sub.name+' <span class="tag">Tier '+(sub.tierIndex+1)+'/'+total+' • '+(tierNow.name||'')+'</span></div><div class="listbar"><span style="width:'+p+'%"></span></div><div class="small" style="width:120px;text-align:right">'+sub.quests.length+' quests</div>';
    el.onclick=(function(idSub){ return function(){ openSub(idSub); }; })(sub.id);
    subsList.appendChild(el);
  }
  drawRadarOn('topicRadarCanvas', main.subs.map(function(s){return s.name;}), main.subs.map(function(s){ s=ensureSub(s); return ((s.tierIndex+1)/s.tierConfig.tiers.length)*100; }), 'ความก้าวหน้าแบบหยาบ');
}

backHomeBtn.onclick=function(){ currentMainId=null; renderHome(); };
addSubBtn.onclick=function(){ openSubSetup(); };
deleteMainBtn.onclick=function(){ if(!currentMainId) return; if(!confirm('ลบหัวข้อหลักนี้และทั้งหมดภายใน?')) return; db.topics=db.topics.filter(function(t){return t.id!==currentMainId}); saveDB(db); currentMainId=null; renderHome(); };

/* ===== Sub page ===== */
function openSub(subId){
  currentSubId=subId;
  var main=null; for(var i=0;i<db.topics.length;i++){ if(db.topics[i].id===currentMainId){ main=db.topics[i]; break; } }
  var sub=null; for(i=0;i<main.subs.length;i++){ if(main.subs[i].id===subId){ sub=main.subs[i]; break; } }
  ensureSub(sub);
  mainView.style.display='none'; subView.style.display='grid';
  subTitle.textContent=main.name+' › '+sub.name;
  updateSubHeader(); renderQuests(); renderHistory();
}
backMainBtn.onclick=function(){ openMain(currentMainId); };

function updateSubHeader(){
  var main=null, sub=null, i, j;
  for(i=0;i<db.topics.length;i++){ if(db.topics[i].id===currentMainId){ main=db.topics[i]; break; } }
  for(j=0;j<main.subs.length;j++){ if(main.subs[j].id===currentSubId){ sub=ensureSub(main.subs[j]); break; } }

  var tiers=sub.tierConfig.tiers; var idx=sub.tierIndex;
  var cur=tiers[idx], next=tiers[idx+1];

  toggleClass(tierHead, 'centered', !next);
  toggleClass(tierLeftCol,'center',!next);
  tierRightCol.style.display = next? 'block':'none';
  tierLeftImg.src = (cur&&cur.img)||''; tierRightImg.src=(next&&next.img)||'';
  tierRightTitle.textContent = next? 'Tier ถัดไป':'ถึง Tier สูงสุดแล้ว';
  tierBadge.textContent = 'Tier '+(idx+1)+' / '+tiers.length+(cur&&cur.name?(' • '+cur.name):'');

  var quests=sub.quests, avg=0;
  if(quests.length){
    var sum=0;
    for(i=0;i<quests.length;i++){
      var q=ensureQuest(quests[i]);
      var t=q.tierConfig.tiers[q.tierIndex]||{units:1};
      var r=Math.max(0,Math.min(1,(q.progress)/(t.units||1)));
      sum+=r;
    }
    avg=sum/quests.length;
  }
  var need=(cur&&cur.units)||1;
  buildSegBar(subSegbar, need, avg*need, tierStyleByIndex(idx));
  tierPercent.textContent=Math.round(avg*100)+'%';
  subLive.textContent='ค่า ณ ปัจจุบัน: Tier '+(idx+1)+'/'+tiers.length;
  saveDB(db);
}

function levelUpSubIfReady(){
  var main=null, sub=null, i, j;
  for(i=0;i<db.topics.length;i++){ if(db.topics[i].id===currentMainId){ main=db.topics[i]; break; } }
  for(j=0;j<main.subs.length;j++){ if(main.subs[j].id===currentSubId){ sub=ensureSub(main.subs[j]); break; } }
  var tiers=sub.tierConfig.tiers; var idx=sub.tierIndex;
  if(idx>=tiers.length-1) return;

  var quests=sub.quests, avg=0;
  if(quests.length){
    var sum=0;
    for(i=0;i<quests.length;i++){
      var q=ensureQuest(quests[i]), t=q.tierConfig.tiers[q.tierIndex]||{units:1};
      sum+=Math.max(0,Math.min(1,(q.progress)/(t.units||1)));
    }
    avg=sum/quests.length;
  }
  var need=(tiers[idx]&&tiers[idx].units)||1;
  if(avg*need>=need-1e-9){
    sub.tierIndex++;
    sub.logs.push({time:nowISO(),type:'SUB_TIER_UP',detail:'เลื่อนเป็น Tier '+(sub.tierIndex+1)+' • '+(tiers[sub.tierIndex].name||'')});
    for(i=0;i<sub.quests.length;i++){ sub.quests[i].progress=0; }
    alert('เลื่อนเป็น Tier '+(sub.tierIndex+1));
    saveDB(db); updateSubHeader(); renderQuests(); renderHistory();
  }
}

/* ===== Quests ===== */
function renderQuests(){
  var main=null, sub=null, i;
  for(i=0;i<db.topics.length;i++){ if(db.topics[i].id===currentMainId){ main=db.topics[i]; break; } }
  for(i=0;i<main.subs.length;i++){ if(main.subs[i].id===currentSubId){ sub=ensureSub(main.subs[i]); break; } }
  var box=byId('questsList'); box.innerHTML='';
  if(!sub.quests.length){ var empty=document.createElement('div'); empty.className='small'; empty.textContent='ยังไม่มี Quest'; box.appendChild(empty); }
  for(i=0;i<sub.quests.length;i++){
    (function(q){
      ensureQuest(q);
      var tNow=q.tierConfig.tiers[q.tierIndex]||{name:'',units:1,cond:''};
      var row=document.createElement('div'); row.className='quest-row quest-card';
      var prog=document.createElement('div'); buildSegBar(prog, tNow.units||1, q.progress||0, tierStyleByIndex(q.tierIndex));
      row.innerHTML='<div><div style="font-weight:700">'+q.title+' <span class="tag">T'+(q.tierIndex+1)+'/'+q.tierConfig.tiers.length+' • '+tNow.name+'</span></div><div class="small" style="margin-top:4px">'+(tNow.cond?('เงื่อนไข: '+tNow.cond):'')+'</div><div class="small">หน่วยที่ต้องใช้ใน Tier นี้: '+tNow.units+'</div></div><div></div><div class="row" style="justify-content:flex-end"><button class="btn success">เพิ่ม +</button><button class="btn danger">ลด −</button><button class="btn secondary">แก้ไข</button><button class="btn ghost">ลบ</button></div>';
      row.children[1].appendChild(prog);
      var btns=row.querySelectorAll('button');
      btns[0].onclick=function(){
        if(q.tierIndex>=q.tierConfig.tiers.length-1 && q.progress>=tNow.units) return;
        q.progress++;
        if(q.progress>=tNow.units){
          if(q.tierIndex<q.tierConfig.tiers.length-1){
            q.tierIndex++; q.progress=0;
            var main2=null, sub2=null, k;
            for(k=0;k<db.topics.length;k++){ if(db.topics[k].id===currentMainId){ main2=db.topics[k]; break; } }
            for(k=0;k<main2.subs.length;k++){ if(main2.subs[k].id===currentSubId){ sub2=main2.subs[k]; break; } }
            sub2.logs.push({time:nowISO(),type:'QUEST_TIER_UP',detail:q.title+' → T'+(q.tierIndex+1)});
          }else{ q.progress=tNow.units; }
        }
        saveDB(db); updateSubHeader(); renderQuests(); levelUpSubIfReady();
      };
      btns[1].onclick=function(){ q.progress=Math.max(0,q.progress-1); saveDB(db); updateSubHeader(); renderQuests(); };
      btns[2].onclick=function(){ openQuestSetup(q); };
      btns[3].onclick=function(){ if(!confirm('ลบ Quest นี้?')) return; sub.quests=sub.quests.filter(function(x){return x.id!==q.id}); saveDB(db); renderQuests(); updateSubHeader(); };
      box.appendChild(row);
    })(sub.quests[i]);
  }
}
addQuestBtn.onclick=function(){ openQuestSetup(); };

/* ===== History ===== */
function renderHistory(){
  var main=null, sub=null, i;
  for(i=0;i<db.topics.length;i++){ if(db.topics[i].id===currentMainId){ main=db.topics[i]; break; } }
  for(i=0;i<main.subs.length;i++){ if(main.subs[i].id===currentSubId){ sub=ensureSub(main.subs[i]); break; } }
  historyTableBody.innerHTML='';
  var logs=(sub.logs||[]).slice().reverse();
  for(i=0;i<logs.length;i++){
    var r=logs[i]; var tr=document.createElement('tr');
    tr.innerHTML='<td>'+new Date(r.time).toLocaleString()+'</td><td>'+(r.detail||'')+'</td><td>'+(r.type||'')+'</td>';
    historyTableBody.appendChild(tr);
  }
}
exportCsvBtn.onclick=function(){
  var main=null, sub=null, i;
  for(i=0;i<db.topics.length;i++){ if(db.topics[i].id===currentMainId){ main=db.topics[i]; break; } }
  for(i=0;i<main.subs.length;i++){ if(main.subs[i].id===currentSubId){ sub=ensureSub(main.subs[i]); break; } }
  var rows=[['time','type','detail']]; for(i=0;i<(sub.logs||[]).length;i++){ var r=sub.logs[i]; rows.push([r.time,r.type||'',r.detail||'']); }
  var csv=rows.map(function(r){return r.map(function(v){return '"'+String(v).replace(/"/g,'""')+'"';}).join(',');}).join('\n');
  var fn=(main.name||'main').replace(/\s+/g,'_')+'__'+(sub.name||'sub').replace(/\s+/g,'_')+'_logs.csv';
  var a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/plain'})); a.download=fn; document.body.appendChild(a); a.click(); a.remove(); setTimeout(function(){URL.revokeObjectURL(a.href)},1000);
};

deleteSubBtn.onclick=function(){
  if(!confirm('ลบหัวข้อย่อยนี้ทั้งหมด?')) return;
  var main=null, i;
  for(i=0;i<db.topics.length;i++){ if(db.topics[i].id===currentMainId){ main=db.topics[i]; break; } }
  main.subs=main.subs.filter(function(s){return s.id!==currentSubId}); saveDB(db); openMain(currentMainId);
};

/* ===== Setup Modals ===== */
function openSubSetup(){ ssName.value=''; ssCount.value=3; buildSubSetupRows(); subSetupModal.className='modal show'; }
ssCount.oninput=buildSubSetupRows;
function buildSubSetupRows(){
  var n=Math.max(1,Number(ssCount.value||1)); ssRows.innerHTML='';
  for(var i=0;i<n;i++){
    var row=document.createElement('div'); row.className='tier-row';
    row.innerHTML='<div><img class="img-thumb" id="ssImg_'+i+'"><input type="file" accept="image/*" id="ssFile_'+i+'" style="margin-top:6px"></div><div><div class="small">ชื่อ Tier</div><input type="text" id="ssTitle_'+i+'" value="'+(i===0?'Beginner':'Tier '+(i+1))+'"></div><div><div class="small">จำนวนหลอดที่ต้องใช้</div><input type="number" id="ssUnits_'+i+'" min="1" step="1" value="5"></div><div style="text-align:right"><span class="pill">T'+(i+1)+'</span></div>';
    ssRows.appendChild(row);
    (function(idx){
      var file=byId('ssFile_'+idx), img=byId('ssImg_'+idx);
      file.onchange=function(e){ var f=e.target.files[0]; if(!f) return; var r=new FileReader(); r.onload=function(){ img.src=r.result; }; r.readAsDataURL(f); };
    })(i);
  }
}
function createSubFromSetup(){
  var name=(ssName.value||'').trim(); if(!name){ alert('กรุณาใส่ชื่อหัวข้อย่อย'); return; }
  var n=Math.max(1,Number(ssCount.value||1)), tiers=[];
  for(var i=0;i<n;i++){
    var tName=byId('ssTitle_'+i).value||('Tier '+(i+1));
    var units=Math.max(1,Number(byId('ssUnits_'+i).value||1));
    var img=byId('ssImg_'+i).src||'';
    tiers.push({name:tName,units:units,img:img});
  }
  var main=null; for(i=0;i<db.topics.length;i++){ if(db.topics[i].id===currentMainId){ main=db.topics[i]; break; } }
  main.subs.push({id:uid(),name:name,tierConfig:{tiers:tiers},tierIndex:0,quests:[],logs:[]});
  saveDB(db); subSetupModal.className='modal'; openMain(currentMainId); // กลับไปหน้าหลัก แล้วกดเข้าย่อยได้
}

/* Quest setup */
function openQuestSetup(editing){
  questSetupModal.className='modal show';
  if(editing){ questSetupModal.setAttribute('data-edit-id', editing.id); qsName.value=editing.title||''; qsCount.value=(editing.tierConfig&&editing.tierConfig.tiers&&editing.tierConfig.tiers.length)||3; }
  else{ questSetupModal.removeAttribute('data-edit-id'); qsName.value=''; qsCount.value=3; }
  buildQuestRows(editing);
}
qsCount.oninput=function(){ buildQuestRows(); };
function buildQuestRows(editing){
  var n=Math.max(1,Number(qsCount.value||1)); qsRows.innerHTML='';
  var tiers=editing?ensureQuest(editing).tierConfig.tiers:null;
  for(var i=0;i<n;i++){
    var units=tiers&&tiers[i]?tiers[i].units:5, name=tiers&&tiers[i]?tiers[i].name:('T'+(i+1)), cond=tiers&&tiers[i]?tiers[i].cond:'';
    var row=document.createElement('div'); row.className='tier-row';
    row.innerHTML='<div style="text-align:center"><span class="pill">T'+(i+1)+'</span></div><div><div class="small">ชื่อ Tier</div><input type="text" id="qsTitle_'+i+'" value="'+name+'"></div><div><div class="small">จำนวนหลอดที่ใช้</div><input type="number" id="qsUnits_'+i+'" min="1" step="1" value="'+units+'"></div><div><div class="small">เงื่อนไข</div><input type="text" id="qsCond_'+i+'" value="'+cond+'" placeholder="ตัวอย่าง: ทำครบ 5 วัน/สัปดาห์"></div>';
    qsRows.appendChild(row);
  }
}
function createQuestFromSetup(){
  var title=(qsName.value||'').trim(); if(!title){ alert('ใส่ชื่อ Quest'); return; }
  var n=Math.max(1,Number(qsCount.value||1)), tiers=[];
  for(var i=0;i<n;i++){
    var name=byId('qsTitle_'+i).value||('T'+(i+1));
    var units=Math.max(1,Number(byId('qsUnits_'+i).value||1));
    var cond=(byId('qsCond_'+i).value||'').trim();
    tiers.push({name:name,units:units,cond:cond});
  }
  var main=null, sub=null;
  for(i=0;i<db.topics.length;i++){ if(db.topics[i].id===currentMainId){ main=db.topics[i]; break; } }
  for(i=0;i<main.subs.length;i++){ if(main.subs[i].id===currentSubId){ sub=ensureSub(main.subs[i]); break; } }
  var editId=questSetupModal.getAttribute('data-edit-id');
  if(editId){
    var q=null; for(i=0;i<sub.quests.length;i++){ if(sub.quests[i].id===editId){ q=sub.quests[i]; break; } }
    q.title=title; q.tierConfig={tiers:tiers}; q.tierIndex=Math.min(q.tierIndex, tiers.length-1); q.progress=0;
  }else{
    sub.quests.push({id:uid(),title:title,tierConfig:{tiers:tiers},tierIndex:0,progress:0});
  }
  saveDB(db); questSetupModal.className='modal'; renderQuests(); updateSubHeader();
}

/* ===== Add / Export ===== */
byId('addTopicBtn').onclick=function(){ var name=prompt('ชื่อหัวข้อหลัก'); if(!name) return; db.topics.push({id:uid(),name:name.trim(),subs:[]}); saveDB(db); renderHome(); };
byId('exportAllBtn').onclick=function(){ var a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(db,null,2)],{type:'text/plain'})); a.download='progress_backup_tier_32c.json'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(function(){URL.revokeObjectURL(a.href)},1000); };

/* ===== Boot ===== */
function start(){
  for(var i=0;i<db.topics.length;i++) ensureMain(db.topics[i]);
  renderHome();
  window.addEventListener('resize', function(){
    drawRadarOn('radarCanvas', db.topics.map(function(t){return t.name||'';}), db.topics.map(topicProgressPercent), 'ภาพรวมแบบง่าย');
    if(currentMainId){
      var m=null; for(var j=0;j<db.topics.length;j++){ if(db.topics[j].id===currentMainId){ m=db.topics[j]; break; } }
      drawRadarOn('topicRadarCanvas', (m.subs||[]).map(function(s){return s.name;}), (m.subs||[]).map(function(s){ s=ensureSub(s); return ((s.tierIndex+1)/s.tierConfig.tiers.length)*100; }), 'ความก้าวหน้าแบบหยาบ');
    }
  });
}
window.addEventListener('DOMContentLoaded', start);
</script>
</body>
</html>
